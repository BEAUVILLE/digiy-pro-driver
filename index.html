<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY DRIVER PRO ‚Äî VTC 0% Commission</title>
  <meta name="theme-color" content="#061b14"/>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=driver-20260130-6"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78);
      --green:#16a34a; --gold:#facc15; --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }

    #guard_status{
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 10px 14px;
      background: rgba(0,0,0,.88);
      color:#fff;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      z-index: 9999;
      border: 1px solid rgba(255,255,255,.10);
    }

    .app{display:none;}
    html.access-ok .app{display:block;}

    .wrap{
      max-width:760px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:28px;
      box-shadow:0 14px 44px rgba(0,0,0,.35);
      width:100%;
    }

    h1{
      margin:0 0 8px;
      font-size:32px;
      letter-spacing:.2px;
      background:linear-gradient(135deg, var(--green), var(--gold));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    p{margin:0 0 14px; color:var(--muted); line-height:1.6; font-size:16px;}

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(234,255,241,.92);
      font-size:14px;
      font-weight:800;
      margin:14px 0;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:20px;}

    a.btn, button.btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:14px 20px;
      border-radius:14px;
      font-weight:900;
      text-decoration:none;
      border:0;
      cursor:pointer;
      font-size:16px;
      flex:1;
      min-width:200px;
      transition:all .2s;
    }

    .primary{
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      color:#042012;
      box-shadow:0 4px 16px rgba(34,197,94,.30);
    }
    .primary:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(34,197,94,.40);}

    .secondary{
      background:rgba(250,204,21,.14);
      border:1px solid rgba(250,204,21,.25);
      color:var(--text);
    }
    .secondary:hover{background:rgba(250,204,21,.20); border-color:rgba(250,204,21,.40);}

    .ghost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      color:var(--text);
    }
    .ghost:hover{background:rgba(255,255,255,.12);}

    .hr{height:1px; background:rgba(255,255,255,.12); margin:20px 0;}

    .note{
      margin-top:14px;
      font-size:13px;
      color:rgba(234,255,241,.76);
      line-height:1.6;
      padding:12px;
      background:rgba(0,0,0,.20);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
    }

    @media(max-width:640px){
      .row{flex-direction:column;}
      a.btn, button.btn{width:100%;}
    }
  </style>
</head>

<body>
  <div id="guard_status">üîê V√©rification...</div>

  <div class="app">
    <div class="wrap">
      <div class="card">
        <h1>üöó DIGIY DRIVER PRO</h1>
        <p>
          Bienvenue <strong id="driverTitle">chauffeur</strong> dans ton espace professionnel.
          <strong>0% commission</strong> sur toutes tes courses.
        </p>

        <div class="pill">
          ‚úÖ <span id="userPhone">+221‚Ä¶</span> ‚Ä¢ Abonnement actif
        </div>

        <div class="hr"></div>

        <div class="row">
          <a class="btn primary" data-nav="driver-zone-now.html" href="./driver-zone-now.html">üöó Entrer dans la zone</a>
          <a class="btn secondary" data-nav="courses.html" href="./courses.html">üìã Voir les courses</a>
          <a class="btn secondary" data-nav="profil-chauffeur.html" href="./profil-chauffeur.html">üë§ Mon profil</a>
          <a class="btn secondary" data-nav="mes-lieux.html" href="./mes-lieux.html">üìç Mes lieux</a>
        </div>

        <!-- ‚úÖ Bouton test (ouvre courses avec flag) -->
        <div class="row" style="margin-top:12px">
          <button class="btn secondary" id="btnMakeTest" type="button">‚ûï Course test</button>
          <a class="btn ghost" id="btnLogout" href="./pin.html">üö™ Me d√©connecter</a>
        </div>

        <div class="note">
          <strong>üì¶ Ton abonnement DRIVER PRO</strong><br>
          ‚Ä¢ Prix : <strong>9,900 FCFA / mois</strong><br>
          ‚Ä¢ Paiement : <strong>Wave</strong><br>
          ‚Ä¢ Commission : <strong>0%</strong> (tu gardes 100%)<br>
          ‚Ä¢ Support : <strong>JB BEAUVILLE</strong> ‚Äî WhatsApp <strong>+221 77 134 28 89</strong>
        </div>
      </div>
    </div>
  </div>

  <script>
  (async () => {
    // ‚úÖ attendre guard
    let attempts = 0;
    while (!window.DIGIY_GUARD && attempts < 50) {
      await new Promise(r => setTimeout(r, 100));
      attempts++;
    }
    if (!window.DIGIY_GUARD) {
      document.getElementById("guard_status").textContent = "‚ùå guard.js non charg√©";
      return;
    }

    // ‚úÖ slug depuis URL ou session
    const u = new URL(location.href);
    const s0 = window.DIGIY_GUARD.getSession?.();
    const slug = (u.searchParams.get("slug") || s0?.slug || "").trim().toLowerCase();

    // ‚úÖ session check
    const session = window.DIGIY_GUARD.getSession?.();
    if (!session || !session.owner_id) {
      const pinUrl = slug ? `./pin.html?slug=${encodeURIComponent(slug)}` : "./pin.html";
      console.log("‚ùå Pas de session, redirection vers:", pinUrl);
      location.replace(pinUrl);
      return;
    }

    console.log("‚úÖ Session OK, owner_id:", session.owner_id);

    // ‚úÖ afficher app
    document.documentElement.classList.add("access-ok");

    // ‚úÖ status badge
    const gs = document.getElementById("guard_status");
    if (gs) {
      gs.textContent = "‚úÖ Connect√©";
      setTimeout(() => gs.style.display = "none", 700);
    }

    // ‚úÖ infos
    const phoneEl = document.getElementById("userPhone");
    if (phoneEl) phoneEl.textContent = session.phone || "+221‚Ä¶";

    const titleEl = document.getElementById("driverTitle");
    if (titleEl) titleEl.textContent = session.title || "chauffeur";

    // ‚úÖ MINI BRIQUE : patch boutons data-nav (+ logout)
    if (slug) {
      document.querySelectorAll("a[data-nav]").forEach(a => {
        const file = a.getAttribute("data-nav");
        a.href = "./" + file + "?slug=" + encodeURIComponent(slug);
      });
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) btnLogout.href = "./pin.html?slug=" + encodeURIComponent(slug);
    }

    // ‚úÖ Course test ‚Üí ouvre courses.html?make_test=1 (la page courses g√®re la cr√©ation)
    document.getElementById("btnMakeTest").addEventListener("click", () => {
      if (!confirm("Cr√©er une course test maintenant fr√©rot ?")) return;
      const target = new URL("./courses.html", location.href);
      if (slug) target.searchParams.set("slug", slug);
      target.searchParams.set("make_test", "1");
      location.href = target.toString();
    });

    // ‚úÖ logout (clear session)
    document.getElementById("btnLogout").addEventListener("click", (e) => {
      e.preventDefault();
      if (confirm("Tu veux vraiment te d√©connecter fr√©rot ?")) {
        window.DIGIY_GUARD.logout("./pin.html");
      }
    });
  })();
  </script>
</body>
</html>
