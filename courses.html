<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER PRO ‚Äî Courses</title>
  <meta name="theme-color" content="#F8FAF6" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#F8FAF6; --card:#fff; --line:#E5E7EB;
      --text:#111827; --muted:#6B7280;
      --gold:#EAB308; --green:#16A34A; --red:#EF4444; --blue:#2563EB;
      --radius:18px; --shadow:0 12px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(234,179,8,.18), transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(248,250,246,.92); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:16px;display:grid;place-items:center;
      border:1px solid var(--line);
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);
      color:#92400E;font-weight:950;font-size:20px;
      box-shadow:0 10px 24px rgba(234,179,8,.12);
    }
    .titles{display:flex;flex-direction:column}
    .t1{font-weight:950;letter-spacing:.02em}
    .t2{font-size:12px;color:var(--muted);font-weight:700;margin-top:2px}
    .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:#fff;font-weight:900;font-size:13px;color:#111827;
    }
    .pill.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d}
    .pill.bad{border-color:rgba(239,68,68,.22); background:rgba(239,68,68,.06); color:#7f1d1d}
    .btn{
      border:0;border-radius:14px;padding:10px 12px;min-height:42px;
      font-weight:950;cursor:pointer;
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);color:#78350F;
    }
    .btn.ghost{background:#fff;border:1px solid var(--line);color:#111827;font-weight:900}
    .btn.red{background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.25); color:#991b1b}
    .btn.green{background:rgba(22,163,74,.10); border:1px solid rgba(22,163,74,.25); color:#14532d}
    .btn.blue{background:rgba(37,99,235,.10); border:1px solid rgba(37,99,235,.22); color:#1e3a8a}
    main .wrap{padding-top:16px}
    .grid{
      display:grid;gap:14px;
      grid-template-columns: 1.15fr .85fr;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px;
    }
    .card h3{
      margin:0 0 10px; font-size:14px; letter-spacing:.02em;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .muted{color:var(--muted);font-weight:700}
    .list{display:flex;flex-direction:column;gap:10px}
    .ride{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      display:flex; gap:12px; justify-content:space-between; align-items:flex-start;
      background:#fff;
    }
    .ride-left{display:flex;flex-direction:column;gap:6px}
    .ride-title{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
      font-weight:950;
    }
    .tag{
      font-size:12px;font-weight:950;border-radius:999px;padding:4px 9px;border:1px solid var(--line);
      background:#F9FAFB;color:#111827;
    }
    .tag.new{border-color:rgba(37,99,235,.22); background:rgba(37,99,235,.06); color:#1e3a8a}
    .tag.accepted{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d}
    .tag.cancelled{border-color:rgba(239,68,68,.22); background:rgba(239,68,68,.06); color:#7f1d1d}
    .kv{font-size:13px;color:#111827}
    .kv b{color:#111827}
    .small{font-size:12px;color:var(--muted);font-weight:700}
    .ride-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .empty{
      padding:14px;border-radius:16px;border:1px dashed var(--line);
      background:#F9FAFB;color:var(--muted);font-weight:800;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .tab{
      border:1px solid var(--line); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:950; cursor:pointer;
    }
    .tab.active{
      border-color:rgba(234,179,8,.45);
      background:rgba(234,179,8,.10);
      color:#78350F;
    }
    .msg{
      margin-top:10px;padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:#F9FAFB;color:var(--muted);font-weight:800;white-space:pre-wrap;
    }
    .msg.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d}
    .msg.bad{border-color:rgba(239,68,68,.22); background:rgba(239,68,68,.06); color:#7f1d1d}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">‚àû</div>
        <div class="titles">
          <div class="t1">DIGIY DRIVER PRO ‚Äî Courses</div>
          <div class="t2">Statuts: new ‚Üí accepted ‚Üí done | cancelled | rejected</div>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="pillPhone">üìû ‚Äî</div>
        <div class="pill bad" id="pillRT">‚óè Realtime OFF</div>
        <button class="btn ghost" id="btnReload">‚Üª Rafra√Æchir</button>
        <button class="btn red" id="btnLogout">D√©connexion</button>
      </div>
    </div>
    <div class="msg" id="msg">Chargement‚Ä¶</div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h3>
          <span>üì• Courses</span>
          <span class="muted" id="metaCounts">‚Äî</span>
        </h3>

        <div class="tabs">
          <button class="tab active" id="tabNew">Nouvelles (new)</button>
          <button class="tab" id="tabMine">Mes courses (assigned)</button>
        </div>

        <div class="list" id="list"></div>
      </section>

      <aside class="card">
        <h3>
          <span>‚öôÔ∏è Actions</span>
          <span class="muted">Terrain</span>
        </h3>

        <div class="small">T√©l√©phone chauffeur = cl√© d‚Äôidentit√© (PIN). RLS par header <b>x-driver-phone</b>.</div>

        <div style="height:10px"></div>

        <button class="btn green" id="btnGoOnline">‚úÖ Je suis dispo</button>
        <button class="btn ghost" id="btnGoOffline">‚õîÔ∏è Indispo</button>

        <div style="height:12px"></div>

        <div class="small">Notes : ‚ÄúAccepter‚Äù passe <b>new ‚Üí accepted</b> atomique. ‚ÄúTerminer‚Äù passe <b>accepted ‚Üí done</b>.</div>
      </aside>
    </div>
  </div>
</main>

<script>
(function(){
  'use strict';

  /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  // ‚úÖ BASE AUTO (GitHub Pages / local / prod)
  const path = location.pathname || "/";
  const parts = path.split("/").filter(Boolean);
  const BASE = (parts.length >= 1) ? ("/" + parts[0]) : "";

  const TABLE = "ride_requests";

  // DOM
  const msg = document.getElementById("msg");
  const listEl = document.getElementById("list");
  const pillPhone = document.getElementById("pillPhone");
  const pillRT = document.getElementById("pillRT");
  const metaCounts = document.getElementById("metaCounts");
  const tabNew = document.getElementById("tabNew");
  const tabMine = document.getElementById("tabMine");
  const btnReload = document.getElementById("btnReload");
  const btnLogout = document.getElementById("btnLogout");
  const btnGoOnline = document.getElementById("btnGoOnline");
  const btnGoOffline = document.getElementById("btnGoOffline");

  function setMsg(t, kind=""){
    msg.className = "msg" + (kind ? " " + kind : "");
    msg.textContent = t;
  }
  window.addEventListener("error", (e)=> setMsg("‚ùå Erreur JS:\n" + (e?.message || e), "bad"));
  window.addEventListener("unhandledrejection", (e)=> setMsg("‚ùå Promesse rejet√©e:\n" + (e?.reason?.message || e?.reason || e), "bad"));

  function getPhone(){
    const s = sessionStorage.getItem("digiy_driver_phone");
    if(s) return s;
    try{
      const a = JSON.parse(localStorage.getItem("digiy_driver_access_pin")||"null");
      return a?.phone || null;
    }catch(_){}
    return null;
  }

  const driverPhone = getPhone();
  if(!driverPhone){
    setMsg("‚ö†Ô∏è Session chauffeur absente. Redirection‚Ä¶", "bad");
    setTimeout(()=> location.replace(BASE + "/authentification-chauffeur.html"), 200);
    return;
  }
  pillPhone.textContent = "üìû " + driverPhone;

  // ‚úÖ Supabase client avec HEADER RLS
  if(!window.supabase?.createClient){
    setMsg("‚ùå Supabase non charg√© (CDN).", "bad");
    return;
  }
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: { headers: { "x-driver-phone": driverPhone } }
  });

  // UI state
  let view = "new"; // 'new' | 'mine'
  let realtimeOn = false;
  let channel = null;

  function setTab(){
    tabNew.classList.toggle("active", view==="new");
    tabMine.classList.toggle("active", view==="mine");
  }

  function fmtWhen(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString("fr-FR", { dateStyle:"short", timeStyle:"short" });
    }catch(_){ return ts || "‚Äî"; }
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function rideCard(r){
    const status = r.status || "‚Äî";
    const tagCls = status==="new" ? "new" : (status==="accepted" ? "accepted" : (status==="cancelled" ? "cancelled" : ""));
    const pickup = r.pickup_text || r.pickup_name || "‚Äî";
    const dropoff = r.dropoff_text || r.dropoff_name || "‚Äî";
    const city = r.city || "‚Äî";
    const clientPhone = r.client_phone || "‚Äî";
    const created = r.created_at || r.inserted_at || r.created || r.createdAt || null;

    const isMine = (r.assigned_driver_phone && r.assigned_driver_phone === driverPhone);

    const canAccept = (view==="new" && status==="new");
    const canHide = (view==="new" && status==="new");
    const canDone = (view==="mine" && isMine && status==="accepted");
    const canCancel = (view==="mine" && isMine && (status==="accepted" || status==="new"));

    return `
      <div class="ride" data-id="${escapeHtml(r.id)}">
        <div class="ride-left">
          <div class="ride-title">
            üöï ${escapeHtml(city)}
            <span class="tag ${tagCls}">${escapeHtml(status)}</span>
          </div>
          <div class="kv">D√©part: <b>${escapeHtml(pickup)}</b></div>
          <div class="kv">Arriv√©e: <b>${escapeHtml(dropoff)}</b></div>
          <div class="small">Client: ${escapeHtml(clientPhone)} ‚Ä¢ ${created ? fmtWhen(created) : "‚Äî"}</div>
          ${r.driver_name ? `<div class="small">Chauffeur: <b>${escapeHtml(r.driver_name)}</b></div>` : ``}
          ${r.driver_vehicle ? `<div class="small">V√©hicule: <b>${escapeHtml(r.driver_vehicle)}</b></div>` : ``}
        </div>

        <div class="ride-actions">
          ${canAccept ? `<button class="btn green" data-act="accept">Accepter</button>` : ``}
          ${canHide ? `<button class="btn ghost" data-act="hide">Masquer</button>` : ``}
          ${canDone ? `<button class="btn blue" data-act="done">Terminer</button>` : ``}
          ${canCancel ? `<button class="btn red" data-act="cancel">Annuler</button>` : ``}
          <button class="btn ghost" data-act="copy">Copier ID</button>
        </div>
      </div>
    `;
  }

  async function load(){
    setMsg("üü° Chargement‚Ä¶", "");
    listEl.innerHTML = "";
    try{
      let q = sb.from(TABLE).select("*").order("created_at", { ascending:false }).limit(80);

      if(view==="new"){
        q = q.eq("status","new");
        // exclure masqu√©s par ce driver (si colonne existe)
        // (si la colonne n'existe pas, PostgREST renvoie une erreur; on catch plus bas)
        q = q.or(`hidden_by_driver_phone.is.null,not.hidden_by_driver_phone.cs.{${driverPhone}}`);
      }else{
        // mes courses
        q = q.eq("assigned_driver_phone", driverPhone);
      }

      const { data, error } = await q;
      if(error){
        // fallback si "hidden_by_driver_phone" n'existe pas dans ton sch√©ma
        if(view==="new" && String(error.message||"").toLowerCase().includes("hidden_by_driver_phone")){
          const { data: d2, error: e2 } = await sb.from(TABLE).select("*").eq("status","new").order("created_at",{ascending:false}).limit(80);
          if(e2) throw e2;
          render(d2||[]);
          return;
        }
        throw error;
      }
      render(data||[]);
    } catch(e){
      setMsg("‚ùå Erreur load:\n" + (e?.message || e), "bad");
    }
  }

  function render(rows){
    const n = rows.length;
    metaCounts.textContent = (view==="new" ? `Nouvelles: ${n}` : `Mes courses: ${n}`);
    if(!n){
      listEl.innerHTML = `<div class="empty">Aucune course ici pour l‚Äôinstant.</div>`;
      setMsg("‚úÖ Pr√™t.", "ok");
      return;
    }
    listEl.innerHTML = rows.map(rideCard).join("");
    setMsg("‚úÖ Pr√™t.", "ok");
  }

  // Actions
  listEl.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const card = e.target.closest(".ride");
    if(!card) return;
    const rideId = card.getAttribute("data-id");
    const act = btn.getAttribute("data-act");

    if(act==="copy"){
      try{ await navigator.clipboard.writeText(rideId); setMsg("üìã ID copi√©.", "ok"); }catch(_){ setMsg("‚ö†Ô∏è Copie impossible.", "bad"); }
      return;
    }

    if(act==="accept"){
      btn.disabled = true; btn.textContent = "‚è≥ Accept‚Ä¶";
      try{
        const driverName = prompt("Nom chauffeur (optionnel)", "Mamadou D.") || null;
        const driverVehicle = prompt("V√©hicule (optionnel)", "Corolla DK-1234-AB") || null;

        const { data, error } = await sb.rpc("accept_ride_request_atomic", {
          p_ride_id: rideId,
          p_driver_phone: driverPhone,
          p_driver_name: driverName,
          p_driver_vehicle: driverVehicle
        });
        if(error) throw error;

        setMsg("‚úÖ Course accept√©e (atomique).", "ok");
        // bascule direct sur "Mes courses"
        view = "mine"; setTab();
        await load();

      }catch(err){
        setMsg("‚ùå Impossible d‚Äôaccepter:\n" + (err?.message || err), "bad");
        await load();
      }finally{
        btn.disabled = false; btn.textContent = "Accepter";
      }
      return;
    }

    if(act==="hide"){
      btn.disabled = true; btn.textContent = "‚è≥ Masque‚Ä¶";
      try{
        const { data, error } = await sb.rpc("hide_ride_for_driver", {
          p_ride_id: rideId,
          p_driver_phone: driverPhone
        });
        if(error) throw error;

        setMsg("‚úÖ Course masqu√©e pour toi.", "ok");
        await load();
      }catch(err){
        setMsg("‚ùå Impossible de masquer:\n" + (err?.message || err), "bad");
      }finally{
        btn.disabled = false; btn.textContent = "Masquer";
      }
      return;
    }

    if(act==="done"){
      if(!confirm("Terminer la course (done) ?")) return;
      btn.disabled = true; btn.textContent = "‚è≥ Done‚Ä¶";
      try{
        const { error } = await sb.from(TABLE)
          .update({ status: "done" })
          .eq("id", rideId);
        if(error) throw error;

        setMsg("‚úÖ Course termin√©e (done).", "ok");
        await load();
      }catch(err){
        setMsg("‚ùå Impossible de terminer:\n" + (err?.message || err), "bad");
      }finally{
        btn.disabled = false; btn.textContent = "Terminer";
      }
      return;
    }

    if(act==="cancel"){
      if(!confirm("Annuler la course (cancelled) ?")) return;
      btn.disabled = true; btn.textContent = "‚è≥ Cancel‚Ä¶";
      try{
        const { error } = await sb.from(TABLE)
          .update({ status: "cancelled", cancelled_by: "driver", cancelled_at: new Date().toISOString() })
          .eq("id", rideId);
        if(error) throw error;

        setMsg("‚úÖ Course annul√©e.", "ok");
        await load();
      }catch(err){
        setMsg("‚ùå Impossible d‚Äôannuler:\n" + (err?.message || err), "bad");
      }finally{
        btn.disabled = false; btn.textContent = "Annuler";
      }
      return;
    }
  });

  // Tabs
  tabNew.addEventListener("click", async ()=>{
    view = "new"; setTab(); await load();
  });
  tabMine.addEventListener("click", async ()=>{
    view = "mine"; setTab(); await load();
  });

  btnReload.addEventListener("click", load);

  btnLogout.addEventListener("click", ()=>{
    sessionStorage.removeItem("digiy_driver_ok");
    sessionStorage.removeItem("digiy_driver_phone");
    setMsg("üßπ D√©connexion‚Ä¶", "");
    setTimeout(()=> location.replace(BASE + "/authentification-chauffeur.html"), 120);
  });

  btnGoOnline.addEventListener("click", ()=> setMsg("‚úÖ Dispo (logique m√©tier √† brancher si besoin).", "ok"));
  btnGoOffline.addEventListener("click", ()=> setMsg("‚õîÔ∏è Indispo (logique m√©tier √† brancher si besoin).", ""));

  // Realtime
  function startRealtime(){
    try{
      channel = sb.channel("digiy_driver_rides")
        .on("postgres_changes", { event:"*", schema:"public", table: TABLE }, (payload)=>{
          // refresh l√©ger
          load();
        })
        .subscribe((status)=>{
          realtimeOn = (status === "SUBSCRIBED");
          pillRT.className = "pill " + (realtimeOn ? "ok":"bad");
          pillRT.textContent = realtimeOn ? "‚óè Realtime ON" : "‚óè Realtime OFF";
        });
    } catch(e){
      pillRT.className = "pill bad";
      pillRT.textContent = "‚óè Realtime OFF";
    }
  }

  // init
  setTab();
  setMsg("üü° Initialisation‚Ä¶", "");
  startRealtime();
  load();

})();
</script>
</body>
</html>
