<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ü¶Ö PORTE PIN ‚Äî DIGIY PRO DRIVER</title>
  <meta name="theme-color" content="#061b14"/>

  <!-- Supabase CDN (guard en d√©pend) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ Guard (doit √™tre dans le m√™me repo / m√™me dossier que pin.html) -->
  <script src="./guard.js?v=driver-pin-final"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --green:#22c55e; --red:#fb7185;
      --shadow:0 18px 55px rgba(0,0,0,.45); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(900px 520px at 110% 0%, rgba(250,204,21,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{width:100%; max-width:560px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:22px;
      box-shadow:var(--shadow);
    }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex; flex-direction:column; gap:4px;}
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      font-weight:950;
      background:linear-gradient(135deg, var(--green), var(--gold));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-weight:750;
      line-height:1.45;
      font-size:13px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(234,255,241,.92);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .chip b{color:var(--gold)}
    .hr{height:1px; background:rgba(255,255,255,.12); margin:14px 0}
    .label{
      font-size:13px;
      font-weight:900;
      color:rgba(234,255,241,.92);
      margin:0 0 8px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .label small{color:rgba(234,255,241,.70); font-weight:800;}
    .row{display:flex; gap:10px; align-items:stretch;}
    input{
      flex:1;
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-size:18px;
      font-weight:900;
      letter-spacing:.22em;
      outline:none;
    }
    input:focus{border-color:rgba(250,204,21,.55)}
    .iconbtn{
      width:56px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .btn{
      width:100%;
      margin-top:12px;
      border:0;
      border-radius:14px;
      padding:14px 16px;
      font-size:16px;
      font-weight:950;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .btn:active{transform:scale(.99)}
    .primary{
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      color:#042012;
      box-shadow:0 8px 22px rgba(34,197,94,.25);
    }
    .primary:hover{box-shadow:0 12px 28px rgba(34,197,94,.35)}
    .ghost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      color:var(--text);
      box-shadow:none;
    }
    .msg{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--muted);
      font-weight:800;
      line-height:1.55;
      font-size:13px;
    }
    .msg.ok{border-color:rgba(34,197,94,.35); color:rgba(187,247,208,.95)}
    .msg.bad{border-color:rgba(251,113,133,.35); color:rgba(254,202,202,.95)}
    .tiny{
      margin-top:10px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:rgba(234,255,241,.70);
      font-weight:800;
      font-size:12px;
    }
    .a{color:var(--gold); text-decoration:none; font-weight:950;}
    .a:hover{text-decoration:underline}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <h1>ü¶Ö PORTE PIN ‚Äî DIGIY PRO DRIVER</h1>
          <p class="sub">Acc√®s s√©curis√© ‚Äî PIN requis</p>
        </div>
        <div class="chip">
          <span>MODULE</span> <b>driver_pro</b>
        </div>
      </div>

      <div class="chip" style="width:100%; justify-content:space-between">
        <span>SLUG :</span>
        <b id="slugText">‚Äî</b>
      </div>

      <div class="hr"></div>

      <div class="label">
        <span>Entre ton PIN</span>
        <small id="hint">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</small>
      </div>

      <div class="row">
        <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" />
        <button class="iconbtn" id="toggle" type="button" aria-label="Afficher/masquer PIN">üëÅÔ∏è</button>
      </div>

      <button class="btn primary" id="btnEnter" type="button">üöÄ ENTRER</button>
      <button class="btn ghost" id="btnBack" type="button">‚¨ÖÔ∏è Retour</button>

      <div class="msg" id="msg">
        üîí Entre ton PIN pour ouvrir ton espace DRIVER PRO.
      </div>

      <div class="tiny">
        <span>Support : <a class="a" href="https://wa.me/221771342889" target="_blank" rel="noopener noreferrer">WhatsApp</a></span>
        <span id="guardState">Guard: ‚Ä¶</span>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // ‚úÖ CONFIG : page cockpit cible
    // Mets ici ta vraie page cockpit si ce n'est pas cockpit.html
    const COCKPIT_PAGE = "./cockpit.html";

    const $ = (id)=>document.getElementById(id);
    const pinEl = $("pin");
    const slugText = $("slugText");
    const msg = $("msg");
    const btnEnter = $("btnEnter");
    const btnBack = $("btnBack");
    const toggle = $("toggle");
    const guardState = $("guardState");
    const hint = $("hint");

    function setMsg(text, kind){
      msg.classList.remove("ok","bad");
      if(kind) msg.classList.add(kind);
      msg.textContent = text;
    }

    async function waitGuard(timeoutMs=7000){
      const t0 = Date.now();
      while(Date.now()-t0 < timeoutMs){
        if(window.DIGIY_GUARD && typeof window.DIGIY_GUARD.getSlug === "function") return true;
        await new Promise(r=>setTimeout(r, 50));
      }
      return false;
    }

    function go(url, mode){
      try{
        if(window.DIGIY_GUARD?.go) return window.DIGIY_GUARD.go(url, mode || "assign");
      }catch(_){}
      if(mode === "replace") location.replace(url);
      else location.href = url;
    }

    function smartBack(){
      go("./index.html","replace");
    }

    function looksLikeLocSlug(slug){
      const s = String(slug||"").toLowerCase();
      return s.startsWith("chez-") || s.includes("logement") || s.includes("villa") || s.includes("appart") || s.includes("studio");
    }

    async function resolvePhoneFromSlug(slug){
      // 1) si ton guard expose un resolver, on l'utilise
      try{
        if(window.DIGIY_GUARD?.resolvePhoneFromSlug){
          const p = await window.DIGIY_GUARD.resolvePhoneFromSlug(slug);
          if(p) return String(p);
        }
      }catch(_){}

      // 2) fallback RPC publique
      try{
        if(window.DIGIY_GUARD?.rpc){
          const r = await window.DIGIY_GUARD.rpc("digiy_subscriptions_public_by_slug", { p_slug: slug });
          const data = r?.data ?? r;
          const row = Array.isArray(data) ? data[0] : data;
          return row?.phone ? String(row.phone) : "";
        }
      }catch(e){
        console.warn("resolvePhoneFromSlug fallback error:", e);
      }
      return "";
    }

    async function hasAccessDriver(phone){
      // ‚ö†Ô∏è si ta signature diff√®re, ajuste ici (mais chez toi on l'a d√©j√† utilis√©e c√¥t√© SQL)
      const r = await window.DIGIY_GUARD.rpc("digiy_has_access", { p_phone: phone, p_module: "DRIVER" });
      return (r?.data ?? r) === true;
    }

    async function bypassIfActive(slug){
      try{
        if(!slug || !window.DIGIY_GUARD?.rpc) return false;

        const phone = await resolvePhoneFromSlug(slug);
        if(!phone) return false;

        const ok = await hasAccessDriver(phone);
        if(ok){
          setMsg("‚úÖ Abonnement actif. Entr√©e directe‚Ä¶", "ok");
          go(COCKPIT_PAGE + "?slug=" + encodeURIComponent(slug), "replace");
          return true;
        }
      }catch(e){
        console.warn("bypassIfActive error:", e);
      }
      return false;
    }

    async function boot(){
      const ok = await waitGuard(7000);
      if(!ok){
        guardState.textContent = "Guard: ‚ùå non charg√©";
        setMsg("‚ùå guard.js non charg√© (fichier introuvable ou erreur).", "bad");
        return;
      }
      guardState.textContent = "Guard: ‚úÖ pr√™t";

      // sync slug URL -> LS
      try{ window.DIGIY_GUARD.syncSlugFromUrl?.(); }catch(_){}

      const slug = (window.DIGIY_GUARD.getSlug?.() || "").trim();
      slugText.textContent = slug || "‚Äî";

      if(!slug){
        setMsg("‚ö†Ô∏è Slug manquant. Ouvre la porte avec ?slug=ton-slug", "bad");
      }else if(looksLikeLocSlug(slug)){
        setMsg("‚ö†Ô∏è Ce slug ressemble √† un logement (LOC). Si tu veux DRIVER, utilise le slug chauffeur.", "bad");
      }else{
        setMsg("üîí Entre ton PIN pour ouvrir ton espace DRIVER PRO.", null);
      }

      // ‚úÖ Si session d√©j√† active : cockpit direct (pas index)
      const s = window.DIGIY_GUARD.getSession?.();
      if(s?.owner_id){
        setMsg("‚úÖ Session d√©j√† active. Ouverture cockpit‚Ä¶", "ok");
        go(COCKPIT_PAGE + "?slug=" + encodeURIComponent(slug), "replace");
        return;
      }

      // ‚úÖ BYPASS si abonnement actif
      if(slug){
        const bypassed = await bypassIfActive(slug);
        if(bypassed) return;
      }

      pinEl.focus();

      // UX: masque/affiche
      toggle.addEventListener("click", ()=>{
        const isPwd = pinEl.getAttribute("type") !== "text";
        pinEl.setAttribute("type", isPwd ? "text" : "password");
        toggle.textContent = isPwd ? "üôà" : "üëÅÔ∏è";
        hint.textContent = isPwd ? pinEl.value : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      });

      pinEl.addEventListener("input", ()=>{
        const v0 = pinEl.value;
        const v = v0.replace(/[^\d]/g,"");
        if(v !== v0) pinEl.value = v;
        hint.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      });

      pinEl.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") doLogin();
      });

      btnEnter.addEventListener("click", doLogin);
      btnBack.addEventListener("click", smartBack);
    }

    async function doLogin(){
      btnEnter.disabled = true;

      const slug = (window.DIGIY_GUARD.getSlug?.() || "").trim();
      const pin = String(pinEl.value||"").trim();

      if(!slug){
        setMsg("‚ùå SLUG manquant. Mets ?slug=...", "bad");
        btnEnter.disabled = false;
        return;
      }
      if(!pin || pin.length < 3){
        setMsg("‚ùå PIN trop court.", "bad");
        btnEnter.disabled = false;
        return;
      }

      setMsg("‚è≥ V√©rification‚Ä¶", null);

      try{
        const res = await window.DIGIY_GUARD.loginWithPin(slug, pin);
        if(!res?.ok){
          setMsg("‚ùå " + (res?.error || "PIN invalide."), "bad");
          btnEnter.disabled = false;
          return;
        }

        setMsg("‚úÖ Acc√®s OK. Ouverture cockpit‚Ä¶", "ok");
        go(COCKPIT_PAGE + "?slug=" + encodeURIComponent(slug), "replace");
      }catch(e){
        console.error(e);
        setMsg("‚ùå Erreur: " + (e?.message || e), "bad");
        btnEnter.disabled = false;
      }
    }

    // default type password
    pinEl.setAttribute("type","password");
    boot();
  })();
  </script>
</body>
</html>
