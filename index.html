<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
 <script src="https://apps.digiylyfe.com/digiy-core/digiy-core.js?v=0.1.0"></script>  
  <title>DIGIY DRIVER PRO ‚Äî VTC 0% Commission</title>
  <meta name="theme-color" content="#061b14"/>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=driver-pro-final"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78);
      --green:#16a34a; --gold:#facc15; --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }

    #guard_status{
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 10px 14px;
      background: rgba(0,0,0,.88);
      color:#fff;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      z-index: 9999;
      border: 1px solid rgba(255,255,255,.10);
    }

    .app{display:none;}
    html.access-ok .app{display:block;}

    .wrap{
      max-width:760px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:28px;
      box-shadow:0 14px 44px rgba(0,0,0,.35);
      width:100%;
    }

    h1{
      margin:0 0 8px;
      font-size:32px;
      letter-spacing:.2px;
      background:linear-gradient(135deg, var(--green), var(--gold));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    p{margin:0 0 14px; color:var(--muted); line-height:1.6; font-size:16px;}

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(234,255,241,.92);
      font-size:14px;
      font-weight:800;
      margin:14px 0;
      flex-wrap:wrap;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:20px;}

    a.btn, button.btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:14px 20px;
      border-radius:14px;
      font-weight:900;
      text-decoration:none;
      border:0;
      cursor:pointer;
      font-size:16px;
      flex:1;
      min-width:200px;
      transition:all .2s;
    }

    .primary{
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      color:#042012;
      box-shadow:0 4px 16px rgba(34,197,94,.30);
    }
    .primary:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(34,197,94,.40);}

    .secondary{
      background:rgba(250,204,21,.14);
      border:1px solid rgba(250,204,21,.25);
      color:var(--text);
    }
    .secondary:hover{background:rgba(250,204,21,.20); border-color:rgba(250,204,21,.40);}

    .ghost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      color:var(--text);
    }
    .ghost:hover{background:rgba(255,255,255,.12);}

    .hr{height:1px; background:rgba(255,255,255,.12); margin:20px 0;}

    .note{
      margin-top:14px;
      font-size:13px;
      color:rgba(234,255,241,.76);
      line-height:1.6;
      padding:12px;
      background:rgba(0,0,0,.20);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
    }

    /* ‚úÖ KPI Cockpit */
    .kpis{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin:16px 0 6px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
    }
    .kpi .label{font-size:12px; color:rgba(234,255,241,.72); font-weight:800;}
    .kpi .value{font-size:18px; font-weight:1000; margin-top:6px;}
    .kpi.small .value{font-size:14px; font-weight:900;}
    @media(max-width:640px){ .kpis{grid-template-columns:1fr;} }

    .module-viewer{
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.12), transparent 55%),
        var(--bg);
      z-index: 9998;
      display:flex;
      flex-direction:column;
    }
    .module-viewer.hidden{display:none;}
    .viewer-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
    }
    .viewer-topbar .title{
      font-weight:900;
      letter-spacing:.2px;
      color:rgba(234,255,241,.92);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .viewer-topbar .actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .viewer-topbar button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .viewer-topbar button:hover{background:rgba(255,255,255,.12);}
    #moduleFrame{
      width:100%;
      flex:1;
      border:none;
      background:#000;
    }

    @media(max-width:640px){
      .row{flex-direction:column;}
      a.btn, button.btn{width:100%;}
    }
  </style>
</head>

<body>
  <div id="guard_status">üîê V√©rification...</div>

  <div class="app">
    <div class="wrap">
      <div class="card">
        <h1>üöó DIGIY DRIVER PRO</h1>
        <p>
          Bienvenue <strong id="driverTitle">chauffeur</strong> dans ton espace professionnel.
          <strong>0% commission</strong> sur toutes tes courses.
        </p>

        <div class="pill">
          ‚úÖ <span id="userPhone">+221‚Ä¶</span>
          <span id="pillSep1">‚Ä¢</span>
          <span id="pillSlug">Lieu : ‚Äî</span>
          <span id="pillSep2">‚Ä¢</span>
          <span>Abonnement actif</span>
        </div>

        <div class="hr"></div>

        <!-- ‚úÖ KPI COCKPIT -->
        <div class="kpis" aria-label="KPI Cockpit Chauffeur">
          <div class="kpi">
            <div class="label">Courses aujourd‚Äôhui</div>
            <div class="value" id="kpiTripsToday">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">CA aujourd‚Äôhui</div>
            <div class="value" id="kpiRevenueToday">‚Äî</div>
          </div>

          <div class="kpi">
            <div class="label">Courses 7 jours</div>
            <div class="value" id="kpiTrips7d">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">CA 7 jours</div>
            <div class="value" id="kpiRevenue7d">‚Äî</div>
          </div>

          <div class="kpi">
            <div class="label">Courses 30 jours</div>
            <div class="value" id="kpiTrips30d">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">CA 30 jours</div>
            <div class="value" id="kpiRevenue30d">‚Äî</div>
          </div>

          <div class="kpi">
            <div class="label">Total courses</div>
            <div class="value" id="kpiTripsTotal">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="label">Total CA</div>
            <div class="value" id="kpiRevenueTotal">‚Äî</div>
          </div>

          <div class="kpi small">
            <div class="label">Statut / Zone</div>
            <div class="value"><span id="kpiDriverStatus">‚Äî</span> ‚Ä¢ <span id="kpiZone">‚Äî</span></div>
          </div>
          <div class="kpi small">
            <div class="label">Derni√®re course</div>
            <div class="value" id="kpiLastTripAt">‚Äî</div>
          </div>
        </div>

        <div class="row">
          <a class="btn primary" data-go="./driver-zone-now.html" href="#">üöó Entrer dans la zone</a>
          <a class="btn secondary" data-go="./courses.html" href="#">üìã Voir les courses</a>
          <a class="btn secondary" data-go="./profil-chauffeur.html" href="#">üë§ Mon profil</a>
          <a class="btn secondary" data-go="./mes-lieux.html" href="#">üìç Mes lieux</a>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn secondary" id="btnGenerator" type="button">üßæ G√©n√©rer ma fiche</button>
          <button class="btn secondary" id="btnMakeTest" type="button">‚ûï Course test</button>
          <button class="btn ghost" id="btnLogout" type="button">üö™ Me d√©connecter</button>
        </div>

        <div class="note">
          <strong>üì¶ Ton abonnement DRIVER PRO</strong><br>
          ‚Ä¢ Prix : <strong>12 900 FCFA / mois</strong><br>
          ‚Ä¢ Paiement : <strong>Wave</strong><br>
          ‚Ä¢ Commission : <strong>0%</strong> (tu gardes 100%)<br>
          ‚Ä¢ Support : <strong>JB BEAUVILLE</strong> ‚Äî WhatsApp <strong>+221 77 134 28 89</strong><br>
          <span style="display:inline-block;margin-top:6px;opacity:.92">
            ‚ö†Ô∏è <strong>P√©age autoroute non inclus</strong> ‚Äî le client paie directement au poste.
          </span>
        </div>
      </div>
    </div>
  </div>

  <div id="moduleViewer" class="module-viewer hidden" aria-hidden="true">
    <div class="viewer-topbar">
      <div class="title">üßæ G√©n√©rateur ‚Äî Fiche Chauffeur</div>
      <div class="actions">
        <button type="button" id="btnViewerClose">‚Üê Retour cockpit</button>
      </div>
    </div>
    <iframe id="moduleFrame" title="DIGIY DRIVER ‚Äî G√©n√©rateur" referrerpolicy="no-referrer"></iframe>
  </div>

  <!-- NAV / phone propagation -->
  <script>
  (function(){
    "use strict";

    function normPhone(p){
      if(!p) return "";
      let s = String(p).trim();
      s = s.replace(/[^\d+]/g, "");
      if (s && !s.startsWith("+")) {
        if (s.startsWith("221")) s = "+" + s;
      }
      return s;
    }

    function getUrlParam(name){
      try{ return (new URL(location.href)).searchParams.get(name) || ""; }catch(_){}
      return "";
    }

    function withPhoneParam(target){
      const phone = window.DIGIY_DRIVER_HUB_PHONE || "";
      if(!phone) return target;
      try{
        const u = new URL(target, location.href);
        if(!u.searchParams.get("phone")) u.searchParams.set("phone", phone);
        if (u.origin === location.origin) return u.pathname + u.search + u.hash;
        return u.toString();
      }catch(_){
        const sep = target.includes("?") ? "&" : "?";
        return target + sep + "phone=" + encodeURIComponent(phone);
      }
    }

    // capture phone d√®s l'arriv√©e
    const HUB_PHONE = normPhone(getUrlParam("phone"));
    if (HUB_PHONE) {
      try { sessionStorage.setItem("DIGIY_DRIVER_HUB_PHONE", HUB_PHONE); } catch(_){}
      window.DIGIY_DRIVER_HUB_PHONE = HUB_PHONE;
    } else {
      try { window.DIGIY_DRIVER_HUB_PHONE = sessionStorage.getItem("DIGIY_DRIVER_HUB_PHONE") || ""; } catch(_){}
    }

    function go(target, mode){
      const t = withPhoneParam(target);
      try{
        if(window.DIGIY_GUARD?.go) return window.DIGIY_GUARD.go(t, mode || "assign");
      }catch(_){}
      const base = (window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(t) : t);
      if((mode||"assign")==="replace") location.replace(base);
      else location.href = base;
    }

    // Event delegation: un seul listener pour tous les [data-go]
    document.addEventListener("click", (e)=>{
      const el = e.target?.closest?.("[data-go]");
      if(!el) return;
      e.preventDefault();
      const target = (el.getAttribute("data-go") || "").trim();
      const mode = (el.getAttribute("data-mode") || "assign").trim();
      if(!target) return;
      go(target, mode);
    });

    window.DIGIY_NAV = { go, withPhoneParam };
  })();
  </script>

  <!-- Viewer -->
  <script>
  (function(){
    "use strict";
    const viewer = document.getElementById("moduleViewer");
    const frame  = document.getElementById("moduleFrame");
    const btnClose = document.getElementById("btnViewerClose");
    let lastFocusEl = null;

    function openViewer(src, title){
      if(!viewer || !frame) return;
      lastFocusEl = document.activeElement;

      const withSlug = (window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(src) : src);
      const safeSrc = window.DIGIY_NAV?.withPhoneParam ? window.DIGIY_NAV.withPhoneParam(withSlug) : withSlug;

      frame.src = safeSrc;
      const titleEl = viewer.querySelector(".viewer-topbar .title");
      if(titleEl && title) titleEl.textContent = title;

      viewer.classList.remove("hidden");
      viewer.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      btnClose?.focus?.();
    }

    function closeViewer(){
      if(!viewer || !frame) return;
      frame.src = "about:blank";
      viewer.classList.add("hidden");
      viewer.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      lastFocusEl?.focus?.();
    }

    window.DIGIY_VIEWER = { openViewer, closeViewer };
    btnClose?.addEventListener("click", closeViewer);
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && !viewer.classList.contains("hidden")) closeViewer();
    });
  })();
  </script>

  <!-- ‚úÖ Cockpit Stats Loader (RPC cockpit_driver_stats_me) -->
  <script>
  (function(){
    "use strict";

    const money = (n) => `${Number(n || 0).toLocaleString("fr-FR")} FCFA`;
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = (val ?? "‚Äî");
    };

    async function loadOnce(){
      try{
        if(!document.documentElement.classList.contains("access-ok")) return;
        if(!window.DIGIY_GUARD?.rpc) return;

        const res = await window.DIGIY_GUARD.rpc("cockpit_driver_stats_me", {});
        // selon guard.js: parfois res = {data,error} ; parfois data direct
        const payload = res?.data ?? res;
        const row = Array.isArray(payload) ? payload[0] : payload?.[0] || payload;
        if(!row) return;

        set("kpiTripsToday", row.trips_today ?? 0);
        set("kpiRevenueToday", money(row.revenue_today_fcfa));

        set("kpiTrips7d", row.trips_7d ?? 0);
        set("kpiRevenue7d", money(row.revenue_7d_fcfa));

        set("kpiTrips30d", row.trips_30d ?? 0);
        set("kpiRevenue30d", money(row.revenue_30d_fcfa));

        set("kpiTripsTotal", row.trips_total ?? 0);
        set("kpiRevenueTotal", money(row.revenue_total_fcfa));

        set("kpiDriverStatus", row.driver_status || "‚Äî");
        set("kpiZone", row.zone_slug || "‚Äî");
        set("kpiLastTripAt", row.last_trip_at ? new Date(row.last_trip_at).toLocaleString("fr-FR") : "‚Äî");
      }catch(e){
        console.error("cockpit stats error:", e);
      }
    }

    function startAuto(){
      loadOnce();
      setInterval(loadOnce, 30000);
      document.addEventListener("visibilitychange", () => { if(!document.hidden) loadOnce(); });
      window.addEventListener("focus", loadOnce);
    }

    window.DIGIY_COCKPIT_STATS = { loadOnce, startAuto };
  })();
  </script>

  <!-- App boot + ‚úÖ Heartbeat PRO -->
  <script>
  (async () => {
    const MODULE = "driver";
    const PAY_URL = "https://beauville.github.io/commencer-a-payer/";
    const gs = document.getElementById("guard_status");

    function getUrlParam(name){
      try{ return (new URL(location.href)).searchParams.get(name) || ""; }catch(_){}
      return "";
    }

    function getVilleFromSlug(slug){
      const s = (slug || "").toLowerCase();
      if (s.includes("saly")) return "Saly";
      if (s.includes("mbour")) return "Mbour";
      if (s.includes("somone")) return "Somone";
      if (s.includes("ngaparou")) return "Ngaparou";
      return slug || null;
    }

    if(!window.DIGIY_GUARD || typeof window.DIGIY_GUARD.boot !== "function"){
      if(gs) gs.textContent = "‚ùå guard.js non charg√©";
      return;
    }

    const guardRes = await window.DIGIY_GUARD.boot({
      module: MODULE,
      dashboard: "./index.html",
      login: "./pin.html",
      pay: PAY_URL,
      requireSlug: true,
      checkSubscription: true
    });

    if(!guardRes?.ok){
      if(gs) gs.textContent = "‚ùå Acc√®s refus√©";
      return;
    }

    const session = window.DIGIY_GUARD.getSession?.() || null;
    if(!session?.owner_id){
      if(gs) gs.textContent = "‚ùå Session invalide";
      const pinUrl = window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug("./pin.html") : "./pin.html";
      location.replace(pinUrl);
      return;
    }

    document.documentElement.classList.add("access-ok");

    if (gs) {
      gs.textContent = "‚úÖ Connect√©";
      setTimeout(() => gs.style.display = "none", 700);
    }

    // ‚úÖ vars dispo partout
    const slug = window.DIGIY_GUARD.getSlug?.() || getUrlParam("slug") || "";
    const hubPhone = window.DIGIY_DRIVER_HUB_PHONE || "";
    const ville = getVilleFromSlug(slug);

    // =====================================
    // ‚úÖ DRIVER HEARTBEAT PRO (TOKEN MAISON)
    // =====================================
    const token = window.DIGIY_GUARD.getDriverToken?.() || "";

    async function heartbeatPro(){
      if(!token) return;
      try{
        await window.DIGIY_GUARD.rpc("driver_heartbeat_pro", {
          p_token: token,
          p_display_name: session.title || session.business_name || "chauffeur",
          p_driver_phone: session.phone || hubPhone || null,
          p_ville: ville
        });
      }catch(_){}
    }

    heartbeatPro();
    setInterval(heartbeatPro, 25000);
    document.addEventListener("visibilitychange", () => { if(!document.hidden) heartbeatPro(); });
    window.addEventListener("focus", heartbeatPro);

    // UI
    const pillSlug = document.getElementById("pillSlug");
    if (pillSlug) pillSlug.textContent = "Lieu : " + (slug || "‚Äî");

    const phoneEl = document.getElementById("userPhone");
    if (phoneEl) phoneEl.textContent = session.phone || hubPhone || "+221‚Ä¶";

    const titleEl = document.getElementById("driverTitle");
    if (titleEl) titleEl.textContent = session.title || session.business_name || "chauffeur";

    // ‚úÖ Lancer KPI cockpit (auto refresh)
    try { window.DIGIY_COCKPIT_STATS?.startAuto?.(); } catch(_){}

    document.getElementById("btnGenerator")?.addEventListener("click", () => {
      // ‚úÖ nom de fichier propre (sans espaces) ‚Äî adapte si ton repo a un autre nom
      const gen = "./generateur-driver-digiy.html";
      window.DIGIY_VIEWER?.openViewer(gen, "üßæ G√©n√©rateur ‚Äî Fiche Chauffeur");
    });

    document.getElementById("btnMakeTest")?.addEventListener("click", () => {
      if (!confirm("Cr√©er une course test maintenant fr√©rot ?")) return;
      const target = new URL("./courses.html", location.href);
      target.searchParams.set("make_test", "1");
      if (slug) target.searchParams.set("slug", slug);
      if (hubPhone) target.searchParams.set("phone", hubPhone);
      location.href = target.toString();
    });

    document.getElementById("btnLogout")?.addEventListener("click", () => {
      if (!confirm("Tu veux vraiment te d√©connecter fr√©rot ?")) return;
      const pinUrl = window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug("./pin.html") : "./pin.html";
      window.DIGIY_GUARD.logout(pinUrl);
    });
  })();
  </script>

  <!-- ‚úÖ DIGIY KNOWLEDGE ‚Äî Assistant DRIVER PRO -->
  <div data-digiy-module="DRIVER"></div>
  <script defer src="https://knowledge.digiylyfe.com/widget/digiy-widget-pro.js"></script>

</body>
</html>
