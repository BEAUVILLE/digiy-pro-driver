<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIGIY DRIVER PRO ‚Äî Courses</title>
  <meta name="theme-color" content="#F8FAF6" />
  <meta name="description" content="Vue Chauffeur DIGIY DRIVER ‚Äî courses, gains, 0% commission." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#F8FAF6; --card:#ffffff; --line:#E5E7EB;
      --text:#0f172a; --muted:#64748b;
      --gold:#EAB308; --green:#16A34A; --danger:#EF4444; --blue:#2563EB;
      --shadow:0 14px 32px rgba(2,6,23,.08);
      --radius:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font1: "Outfit", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font2: "Manrope", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font2);
      color:var(--text);
      background:
        radial-gradient(900px 400px at 10% -10%, rgba(234,179,8,.16), transparent 55%),
        radial-gradient(900px 400px at 90% -10%, rgba(22,163,74,.14), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 110px}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background:rgba(248,250,246,.82);
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .topbar-inner{max-width:1100px;margin:0 auto;padding:14px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;font-weight:900;
      background:linear-gradient(135deg, rgba(234,179,8,1), rgba(34,197,94,1));
      color:#052e16; box-shadow:0 14px 28px rgba(234,179,8,.20);
      font-family:var(--font1);
    }
    .titles{display:flex;flex-direction:column}
    .t1{font-family:var(--font1);font-weight:950;letter-spacing:.06em}
    .t2{font-size:12px;color:var(--muted);font-weight:800}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.72);
      font-weight:900;font-size:13px;
      box-shadow:0 8px 18px rgba(2,6,23,.05);
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:var(--green)}
    .dot.gray{background:#94a3b8}
    .btn{
      border:none; cursor:pointer;
      border-radius:16px;
      padding:11px 14px;
      font-weight:950;
      font-family:var(--font1);
      letter-spacing:.02em;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
    }
    .btn.primary{background:linear-gradient(135deg,#16A34A,#22C55E);color:white}
    .btn.gold{background:linear-gradient(135deg,#F59E0B,#EAB308);color:#111827}
    .btn.ghost{background:rgba(255,255,255,.7);border:1px solid rgba(15,23,42,.12);color:#0f172a;box-shadow:none}
    .btn.danger{background:linear-gradient(135deg,#EF4444,#F97316);color:#fff}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px;margin-top:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(255,255,255,.86);
      border:1px solid rgba(15,23,42,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .card-h .h1{font-family:var(--font1);font-weight:950}
    .card-h .sub{font-size:12px;color:var(--muted);font-weight:800}
    .card-b{padding:14px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.70);
      padding:12px 12px;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:900}
    .kpi .val{margin-top:6px;font-family:var(--font1);font-weight:980;font-size:22px}
    .kpi .mini{margin-top:2px;font-size:12px;color:rgba(100,116,139,.95);font-weight:800}
    .list{display:flex;flex-direction:column;gap:10px}
    .ride{
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.78);
      border-radius:18px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
    }
    .ride .ttl{font-family:var(--font1);font-weight:980;letter-spacing:.02em}
    .ride .meta{margin-top:6px;font-size:13px;color:rgba(30,41,59,.85);font-weight:700}
    .ride .tags{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
    .tag{
      font-size:12px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(248,250,246,.9);
    }
    .tag.gold{border-color:rgba(234,179,8,.40);background:rgba(234,179,8,.14);color:#92400e}
    .tag.green{border-color:rgba(22,163,74,.34);background:rgba(22,163,74,.12);color:#065f46}
    .tag.blue{border-color:rgba(37,99,235,.28);background:rgba(37,99,235,.10);color:#1d4ed8}
    .tag.red{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.10);color:#991b1b}
    .rightcol{display:flex;flex-direction:column;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .small{font-size:12px;color:var(--muted);font-weight:800}
    .mono{font-family:var(--mono)}
    .sep{height:1px;background:rgba(15,23,42,.08);margin:12px 0}
    .empty{
      padding:18px;border-radius:18px;
      border:1px dashed rgba(15,23,42,.18);
      color:rgba(30,41,59,.78);
      background:rgba(255,255,255,.65);
      font-weight:800;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(15,23,42,.92); color:#fff;
      padding:12px 14px; border-radius:16px;
      font-weight:900; z-index:9999;
      box-shadow:0 16px 34px rgba(2,6,23,.25);
      display:none; max-width:92vw;
    }
    .toast.show{display:block; animation: pop .18s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px);opacity:.3}to{transform:translateX(-50%) translateY(0);opacity:1}}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background:rgba(248,250,246,.92);
      border-top:1px solid rgba(15,23,42,.10);
      backdrop-filter: blur(10px);
    }
    .footerbar .in{max-width:1100px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .link{
      color:#0f172a; font-weight:950; text-decoration:none;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.7);
    }
    .warn{
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.22);
      color:#991b1b;
      padding:10px 12px;border-radius:16px;font-weight:900;
    }
    .ok{
      background:rgba(22,163,74,.10);
      border:1px solid rgba(22,163,74,.22);
      color:#065f46;
      padding:10px 12px;border-radius:16px;font-weight:900;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">ü¶Ö</div>
        <div class="titles">
          <div class="t1">DIGIY DRIVER ‚Äî PRO</div>
          <div class="t2">Courses ‚Ä¢ Gains ‚Ä¢ 0% commission</div>
        </div>
      </div>
      <div class="right">
        <div class="pill">
          <span class="dot gray" id="onlineDot"></span>
          <span id="onlineText">Hors ligne</span>
        </div>
        <button class="btn ghost" id="btnRefresh">Rafra√Æchir</button>
        <button class="btn danger" id="btnLogout">D√©connexion</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <div class="card">
        <div class="card-h">
          <div>
            <div class="h1">Courses disponibles</div>
            <div class="sub">Prix DIGIY = digne. Le chauffeur touche 100%.</div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnToggleOnline">Passer en ligne</button>
          </div>
        </div>
        <div class="card-b">
          <div id="currentRideBox"></div>
          <div class="sep"></div>
          <div class="list" id="ridesList"></div>
          <div id="ridesEmpty" class="empty" style="display:none;">
            Aucune course dispo pour le moment. Reste en ligne, √ßa arrive.
          </div>
        </div>
      </div>

      <div class="rightcol">
        <div class="card">
          <div class="card-h">
            <div>
              <div class="h1">Mon profil</div>
              <div class="sub">Identit√© chauffeur par t√©l√©phone</div>
            </div>
          </div>
          <div class="card-b">
            <div class="small">T√©l√©phone</div>
            <div class="mono" style="font-weight:950;font-size:16px" id="driverPhone">‚Äî</div>
            <div class="sep"></div>
            <div class="small">Nom</div>
            <div style="font-weight:950;font-size:16px" id="driverName">‚Äî</div>
            <div class="small" style="margin-top:10px">V√©hicule</div>
            <div style="font-weight:950" id="driverVehicle">‚Äî</div>
            <div class="small" style="margin-top:10px">Ville</div>
            <div style="font-weight:950" id="driverCity">‚Äî</div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <div class="h1">Mes gains</div>
              <div class="sub">Aujourd‚Äôhui / 7 jours / 30 jours</div>
            </div>
          </div>
          <div class="card-b">
            <div class="kpis">
              <div class="kpi">
                <div class="label">Aujourd‚Äôhui</div>
                <div class="val" id="kpiToday">‚Äî</div>
                <div class="mini" id="kpiTodayCount">‚Äî courses</div>
              </div>
              <div class="kpi">
                <div class="label">7 jours</div>
                <div class="val" id="kpiWeek">‚Äî</div>
                <div class="mini" id="kpiWeekCount">‚Äî courses</div>
              </div>
              <div class="kpi">
                <div class="label">30 jours</div>
                <div class="val" id="kpiMonth">‚Äî</div>
                <div class="mini" id="kpiMonthCount">‚Äî courses</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <div class="h1">Historique</div>
              <div class="sub">Derni√®res courses termin√©es</div>
            </div>
          </div>
          <div class="card-b">
            <div class="list" id="historyList"></div>
            <div id="historyEmpty" class="empty" style="display:none;">
              Pas encore d‚Äôhistorique. Fais ta premi√®re course, fr√®re ü¶Ö
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="footerbar">
    <div class="in">
      <a class="link" href="./index.html">‚Üê Retour</a>
      <div id="netStatus" class="warn">Connexion‚Ä¶</div>
      <a class="link" href="https://digiylyfe.com" target="_blank" rel="noopener">DIGIYLYFE</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: false }
});

/* ‚úÖ BASE AUTO */
const path = location.pathname || "/";
const parts = path.split("/").filter(Boolean);
const BASE = (parts.length >= 1) ? ("/" + parts[0]) : "";

/* ‚úÖ SESSION CHAUFFEUR (PHONE) */
function getDriverPhone(){
  const s = sessionStorage.getItem("digiy_driver_phone");
  if (s) return s;
  try{
    const a = JSON.parse(localStorage.getItem("digiy_driver_access_pin")||"null");
    return a?.phone || null;
  }catch(_){}
  return null;
}
function requirePhone(){
  const phone = getDriverPhone();
  if(!phone){
    location.replace(BASE + "/authentification-chauffeur.html");
    return null;
  }
  return phone;
}
const driverPhone = requirePhone();
document.getElementById("driverPhone").textContent = driverPhone || "‚Äî";

/* UI helpers */
const $ = (id)=>document.getElementById(id);
function fmtF(n){
  if(n==null) return "‚Äî";
  const v = Number(n)||0;
  return v.toLocaleString("fr-FR") + " F";
}
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2400);
}
function setNet(ok){
  const el = $("netStatus");
  if(ok){
    el.className = "ok";
    el.textContent = "Connect√©";
  }else{
    el.className = "warn";
    el.textContent = "Hors ligne / attente r√©seau";
  }
}

/* Tables */
const TABLE_DRIVERS = "drivers";
const TABLE_RIDES   = "ride_requests";
const TABLE_REJ     = "driver_rejections";

let isOnline = false;

function renderOnline(){
  $("onlineDot").className = "dot " + (isOnline ? "green" : "gray");
  $("onlineText").textContent = isOnline ? "En ligne" : "Hors ligne";
  $("btnToggleOnline").textContent = isOnline ? "Passer hors ligne" : "Passer en ligne";
  setNet(true);
}

async function setDriverOnline(next){
  isOnline = !!next;
  renderOnline();
  try{
    await supabase
      .from(TABLE_DRIVERS)
      .update({ is_online: isOnline, last_seen: new Date().toISOString() })
      .eq("phone", driverPhone);
  }catch(_){}
}

$("btnToggleOnline").addEventListener("click", async ()=>{
  await setDriverOnline(!isOnline);
  toast(isOnline ? "Tu es en ligne üü¢" : "Tu es hors ligne ‚ö™");
  await refreshAll();
});

async function loadDriverProfile(){
  try{
    const { data, error } = await supabase
      .from(TABLE_DRIVERS)
      .select("phone,name,city,vehicle_type,vehicle_plate,is_online")
      .eq("phone", driverPhone)
      .maybeSingle();

    if(error) throw error;

    if(data){
      $("driverName").textContent = data.name || "Chauffeur DIGIY";
      $("driverCity").textContent = data.city || "‚Äî";
      const v = [data.vehicle_type, data.vehicle_plate].filter(Boolean).join(" ‚Ä¢ ");
      $("driverVehicle").textContent = v || "‚Äî";
      isOnline = !!data.is_online;
      renderOnline();
    }else{
      $("driverName").textContent = "Chauffeur DIGIY";
      $("driverCity").textContent = "‚Äî";
      $("driverVehicle").textContent = "‚Äî";
      setNet(true);
    }
  }catch(err){
    console.error(err);
    setNet(false);
    toast("R√©seau instable ‚Äî profil non charg√©");
  }
}

function rideCard(ride){
  const price = ride.total_f ?? ride.price ?? null;
  const airportFee = Number(ride.airport_fee_f ?? 0) || 0;
  const vtype = (ride.vehicle_type || "eco").toUpperCase();

  const pickup = ride.pickup_name || ride.pickup_label || "Point de d√©part";
  const dropoff = ride.dropoff_name || ride.dropoff_label || "Destination";

  const tags = [];
  tags.push(`<span class="tag gold">üí∞ Tu touches : ${fmtF(price)} CFA (100%)</span>`);
  if(airportFee > 0) tags.push(`<span class="tag blue">‚úàÔ∏è A√©roport +${fmtF(airportFee)} CFA</span>`);
  if(ride.distance_km != null) tags.push(`<span class="tag green">üìè ${Number(ride.distance_km).toFixed(1)} km</span>`);
  if(ride.duration_min != null) tags.push(`<span class="tag">‚è±Ô∏è ${ride.duration_min} min</span>`);
  tags.push(`<span class="tag">üöó ${vtype}</span>`);
  tags.push(`<span class="tag green">üü¢ Prix garanti</span>`);

  return `
  <div class="ride">
    <div>
      <div class="ttl">üöï Nouvelle ‚Ä¢ ${pickup} ‚Üí ${dropoff}</div>
      <div class="meta"><b>0% commission</b> ‚Ä¢ DIGIY prot√®ge le chauffeur</div>
      <div class="tags">${tags.join("")}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;justify-content:center">
      <button class="btn primary" data-act="accept" data-id="${ride.id}">Accepter</button>
      <button class="btn ghost" data-act="reject" data-id="${ride.id}">Masquer</button>
    </div>
  </div>`;
}

function currentRideBox(ride){
  const price = ride.total_f ?? ride.price ?? null;
  const pickup = ride.pickup_name || "Point de d√©part";
  const dropoff = ride.dropoff_name || "Destination";
  const st = ride.status || "‚Äî";
  const badge =
    st === "accepted" ? `<span class="tag green">‚úÖ Accept√©e</span>` :
    st === "in_progress" ? `<span class="tag gold">üöï En course</span>` :
    st === "arrived" ? `<span class="tag blue">üìç Arriv√©</span>` :
    `<span class="tag">${st}</span>`;

  return `
    <div class="ride" style="border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.06)">
      <div>
        <div class="ttl">üß≠ Course en cours</div>
        <div class="meta"><b>${pickup}</b> ‚Üí <b>${dropoff}</b></div>
        <div class="tags">
          ${badge}
          <span class="tag gold">üí∞ ${fmtF(price)} CFA</span>
          <span class="tag green">üü¢ 100% chauffeur</span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;justify-content:center">
        <button class="btn gold" data-act="start" data-id="${ride.id}">D√©marrer</button>
        <button class="btn danger" data-act="complete" data-id="${ride.id}">Terminer</button>
      </div>
    </div>
  `;
}

async function loadCurrentRide(){
  try{
    const { data, error } = await supabase
      .from(TABLE_RIDES)
      .select("*")
      .eq("assigned_driver_phone", driverPhone)
      .in("status", ["accepted","in_progress","arrived"])
      .order("created_at", { ascending:false })
      .limit(1);

    if(error) throw error;

    if(data && data.length){
      $("currentRideBox").innerHTML = currentRideBox(data[0]);
    }else{
      $("currentRideBox").innerHTML = `<div class="empty">Aucune course en cours. Prends une course et avance ü¶Ö</div>`;
    }
    setNet(true);
  }catch(err){
    console.error(err);
    $("currentRideBox").innerHTML = `<div class="empty">Impossible de charger la course en cours.</div>`;
    setNet(false);
  }
}

async function loadAvailableRides(){
  try{
    // 1) rides masqu√©es
    const { data: rej, error: e1 } = await supabase
      .from(TABLE_REJ)
      .select("ride_id")
      .eq("driver_phone", driverPhone)
      .limit(500);
    if(e1) throw e1;

    const hiddenIds = new Set((rej||[]).map(x => x.ride_id));

    // 2) rides searching (non assign√©es)
    const { data, error } = await supabase
      .from(TABLE_RIDES)
      .select("*")
      .eq("status", "searching")
      .is("assigned_driver_phone", null)
      .order("created_at", { ascending:false })
      .limit(25);
    if(error) throw error;

    const filtered = (data||[]).filter(r => !hiddenIds.has(r.id));

    const list = $("ridesList");
    list.innerHTML = ""; // ‚úÖ anti doublons UI
    $("ridesEmpty").style.display = filtered.length ? "none" : "block";

    if(filtered.length){
      list.innerHTML = filtered.map(rideCard).join("");
    }
    setNet(true);
  }catch(err){
    console.error(err);
    $("ridesList").innerHTML = "";
    $("ridesEmpty").style.display = "block";
    setNet(false);
  }
}

/* ‚úÖ ACCEPT ATOMIQUE (RPC) */
async function acceptRide(rideId){
  if(!isOnline){
    toast("Passe en ligne d‚Äôabord üü¢");
    return;
  }
  try{
    const { data, error } = await supabase.rpc("accept_ride_atomic", {
      p_ride_id: rideId,
      p_driver_phone: driverPhone
    });
    if(error) throw error;

    const res = Array.isArray(data) ? data[0] : data;
    if(!res || res.ok !== true){
      toast("Trop tard : d√©j√† prise par un autre");
      return;
    }
    toast("Course accept√©e ‚úÖ");
    await refreshAll();
  }catch(err){
    console.error(err);
    toast("Erreur acceptation");
    setNet(false);
  }
}

/* ‚úÖ MASQUER DURABLE */
async function rejectRide(rideId){
  try{
    await supabase.from(TABLE_REJ).insert({
      driver_phone: driverPhone,
      ride_id: rideId
    });
    toast("Masqu√© üëç");
    const el = document.querySelector(`button[data-act="reject"][data-id="${rideId}"]`)?.closest(".ride");
    if(el) el.remove();
  }catch(err){
    console.error(err);
    toast("Masquage impossible (r√©seau)");
  }
}

async function startRide(rideId){
  try{
    const { error } = await supabase
      .from(TABLE_RIDES)
      .update({ status: "in_progress", started_at: new Date().toISOString() })
      .eq("id", rideId)
      .eq("assigned_driver_phone", driverPhone)
      .in("status", ["accepted","arrived"]);
    if(error) throw error;
    toast("Course d√©marr√©e üöï");
    await refreshAll();
  }catch(err){
    console.error(err);
    toast("Erreur d√©marrage");
  }
}

async function completeRide(rideId){
  try{
    const { error } = await supabase
      .from(TABLE_RIDES)
      .update({ status: "completed", completed_at: new Date().toISOString() })
      .eq("id", rideId)
      .eq("assigned_driver_phone", driverPhone)
      .in("status", ["in_progress","arrived","accepted"]);
    if(error) throw error;
    toast("Course termin√©e ‚úÖ");
    await refreshAll();
  }catch(err){
    console.error(err);
    toast("Erreur fin course");
  }
}

/* Earnings */
async function loadEarnings(){
  try{
    const { data, error } = await supabase
      .from(TABLE_RIDES)
      .select("total_f,price,completed_at,status")
      .eq("assigned_driver_phone", driverPhone)
      .eq("status","completed")
      .order("completed_at", { ascending:false })
      .limit(800);

    if(error) throw error;

    const now = new Date();
    const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const startWeek = new Date(now.getTime() - 7*24*3600*1000).getTime();
    const startMonth = new Date(now.getTime() - 30*24*3600*1000).getTime();

    let sumToday=0, sumWeek=0, sumMonth=0;
    let cToday=0, cWeek=0, cMonth=0;

    (data||[]).forEach(r=>{
      const t = r.completed_at ? new Date(r.completed_at).getTime() : 0;
      const amt = Number(r.total_f ?? r.price ?? 0) || 0;
      if(t>=startMonth){ sumMonth += amt; cMonth++; }
      if(t>=startWeek){ sumWeek += amt; cWeek++; }
      if(t>=startToday){ sumToday += amt; cToday++; }
    });

    $("kpiToday").textContent = fmtF(sumToday) + " CFA";
    $("kpiWeek").textContent  = fmtF(sumWeek) + " CFA";
    $("kpiMonth").textContent = fmtF(sumMonth) + " CFA";

    $("kpiTodayCount").textContent = `${cToday} courses`;
    $("kpiWeekCount").textContent  = `${cWeek} courses`;
    $("kpiMonthCount").textContent = `${cMonth} courses`;

    setNet(true);
  }catch(err){
    console.error(err);
    setNet(false);
    $("kpiToday").textContent = "‚Äî";
    $("kpiWeek").textContent = "‚Äî";
    $("kpiMonth").textContent = "‚Äî";
  }
}

async function loadHistory(){
  try{
    const { data, error } = await supabase
      .from(TABLE_RIDES)
      .select("id,pickup_name,dropoff_name,total_f,price,completed_at,airport_fee_f,vehicle_type")
      .eq("assigned_driver_phone", driverPhone)
      .eq("status","completed")
      .order("completed_at", { ascending:false })
      .limit(10);
    if(error) throw error;

    const list = $("historyList");
    list.innerHTML = "";

    if(!data || !data.length){
      $("historyEmpty").style.display = "block";
      return;
    }
    $("historyEmpty").style.display = "none";

    list.innerHTML = data.map(r=>{
      const dt = r.completed_at ? new Date(r.completed_at) : null;
      const when = dt ? dt.toLocaleString("fr-FR") : "‚Äî";
      const price = r.total_f ?? r.price ?? null;
      const fee = Number(r.airport_fee_f||0);
      const vt = (r.vehicle_type||"eco").toUpperCase();
      return `
        <div class="ride" style="grid-template-columns:1fr;">
          <div>
            <div class="ttl">‚úÖ ${r.pickup_name||"D√©part"} ‚Üí ${r.dropoff_name||"Arriv√©e"}</div>
            <div class="meta">${when} ‚Ä¢ üöó ${vt}</div>
            <div class="tags">
              <span class="tag gold">üí∞ ${fmtF(price)} CFA</span>
              ${fee>0 ? `<span class="tag blue">‚úàÔ∏è +${fmtF(fee)} CFA</span>` : ``}
              <span class="tag green">üü¢ 100% chauffeur</span>
            </div>
          </div>
        </div>
      `;
    }).join("");
    setNet(true);
  }catch(err){
    console.error(err);
    setNet(false);
    $("historyList").innerHTML = "";
    $("historyEmpty").style.display = "block";
  }
}

/* Click delegation */
document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if(!id) return;

  if(act === "accept") return acceptRide(id);
  if(act === "reject") return rejectRide(id);
  if(act === "start") return startRide(id);
  if(act === "complete") return completeRide(id);
});

/* Refresh */
async function refreshAll(){
  await loadDriverProfile();
  await loadCurrentRide();
  await loadAvailableRides();
  await loadEarnings();
  await loadHistory();
}

/* Logout */
$("btnLogout").addEventListener("click", ()=>{
  sessionStorage.removeItem("digiy_driver_phone");
  toast("D√©connect√©");
  location.replace(BASE + "/authentification-chauffeur.html");
});

/* Manual refresh */
$("btnRefresh").addEventListener("click", async ()=>{
  toast("Refresh‚Ä¶");
  await refreshAll();
});

/* Realtime */
function setupRealtime(){
  try{
    const channel = supabase.channel("digiy_driver_rides_" + driverPhone);

    channel.on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: TABLE_RIDES,
      filter: "status=eq.searching"
    }, async () => {
      if(isOnline) await loadAvailableRides();
    });

    channel.on("postgres_changes", {
      event: "*",
      schema: "public",
      table: TABLE_RIDES,
      filter: "assigned_driver_phone=eq." + driverPhone
    }, async () => {
      await loadCurrentRide();
      await loadEarnings();
      await loadHistory();
    });

    channel.subscribe();
  }catch(err){
    console.warn("Realtime non actif / pas dispo", err);
  }
}

/* Boot */
(async function boot(){
  if(!driverPhone) return;
  setNet(true);
  await refreshAll();
  setupRealtime();
})();
</script>
</body>
</html>
