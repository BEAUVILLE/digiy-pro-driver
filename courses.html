<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Mes Courses ‚Äî DIGIY DRIVER PRO</title>
<meta name="theme-color" content="#061b14"/>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./guard.js?v=driver-live-final"></script>

<style>
:root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--green:#16a34a;--gold:#facc15;--r:18px}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;font-family:system-ui;background:radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),var(--bg);color:var(--text)}
header{position:sticky;top:0;background:rgba(6,27,20,.75);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;justify-content:space-between}
main{padding:16px;max-width:980px;margin:0 auto}
.card{background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:14px}
button{padding:12px;border-radius:12px;border:0;font-weight:900;cursor:pointer}
.btn{background:linear-gradient(135deg,#16a34a,#10b981);color:#042012}
.item{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;margin-top:10px}
.muted{color:var(--muted);font-size:13px}
</style>
</head>

<body>
<header>
  <strong>üöó Mes Courses</strong>
  <button id="btnLogout">D√©connexion</button>
</header>

<main>
  <div class="card">
    <div id="status">Connexion‚Ä¶</div>
    <div class="muted">Slug: <span id="slugBox"></span></div>
    <button class="btn" id="btnRefresh">Actualiser</button>
  </div>

  <div class="card">
    <strong>Courses LIVE</strong>
    <div id="list"></div>
  </div>
</main>

<script>
(async()=>{

const session = window.DIGIY_GUARD.requireSession("./pin.html");
if(!session) return;

const sb = await window.DIGIY_GUARD.getSbAsync();
const list = document.getElementById("list");
const slugBox = document.getElementById("slugBox");
const statusEl = document.getElementById("status");

slugBox.textContent = session.slug;
statusEl.textContent = "‚úÖ Connect√©";

function renderTrips(rows){
  if(!rows.length){
    list.innerHTML="<div class='muted'>Aucune course pour le moment</div>";
    return;
  }

  list.innerHTML = rows.map(tr=>`
    <div class="item">
      <b>${tr.pickup_city || "‚Äî"} ‚Üí ${tr.dropoff_city || "‚Äî"}</b><br>
      ${tr.amount || tr.proposed_price || "‚Äî"} FCFA<br>
      <span class="muted">${new Date(tr.created_at).toLocaleString()}</span>
    </div>
  `).join("");
}

async function createTestTrip(){
  // ‚ö†Ô∏è IMPORTANT : auth_user_id doit √™tre UUID
  // donc on appelle une RPC SECURITY DEFINER
  const { error } = await sb.rpc("create_driver_test_trip", {
    p_driver_slug: session.slug
  });

  if(error) console.warn("Insert test KO:", error);
}

async function loadTrips(){

  // cr√©ation course test si demand√©
  const url = new URL(location.href);
  if(url.searchParams.get("make_test")==="1"){
    await createTestTrip();
    url.searchParams.delete("make_test");
    history.replaceState(null,"",url.toString());
  }

  const { data, error } = await sb
    .from("driver_trips")
    .select("*")
    .eq("driver_slug", session.slug)
    .order("created_at", { ascending:false })
    .limit(20);

  if(error){
    list.innerHTML = "<div class='muted'>RLS bloque la table ‚Üí normal</div>";
    console.warn(error);
    return;
  }

  renderTrips(data || []);
}

document.getElementById("btnRefresh").onclick = loadTrips;
document.getElementById("btnLogout").onclick = ()=>window.DIGIY_GUARD.logout("./pin.html");

await loadTrips();

})();
</script>
</body>
</html>
