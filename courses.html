<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIGIY PRO DRIVER</title>
  <meta name="theme-color" content="#F8FAF6" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<script>
// ✅ URL paiement
const PAY_URL = "https://beauville.github.io/commencer-a-payer/";

// ✅ Check abonnement actif (bloque l'accès au dashboard si past_due)
async function guardSubscriptionOrRedirect(phone){
  try{
    const { data, error } = await supabase.rpc('is_driver_active', { p_phone: phone });
    if (error) throw error;

    if (!data){
      location.replace(PAY_URL + "?phone=" + encodeURIComponent(phone) + "&from=" + encodeURIComponent(location.href));
      return false;
    }
    return true;
  }catch(e){
    console.warn("guardSubscriptionOrRedirect error:", e);
    // Si Supabase down, on ne bloque pas à tort : on laisse passer
    return true;
  }
}
  
(function(){
  'use strict';

  // ✅ BASE AUTO (GitHub Pages / local / prod)
  const path = location.pathname || "/";
  const parts = path.split("/").filter(Boolean);
  const BASE = (parts.length >= 1) ? ("/" + parts[0]) : "";

  // ✅ URL paiement (ton repo commencer-a-payer)
  const PAY_URL = "https://beauville.github.io/commencer-a-payer/";

  // ✅ SUPABASE — DÉJÀ POSÉ
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const supabase = window.__sb || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.__sb = supabase;

  function getPhone(){
    const s = sessionStorage.getItem("digiy_driver_phone");
    if (s) return s;
    try{
      const a = JSON.parse(localStorage.getItem("digiy_driver_access_pin")||"null");
      return a?.phone || null;
    }catch(_){}
    return null;
  }

  async function isActive(phone){
    try{
      // RPC: is_driver_active(p_phone text) -> boolean
      const { data, error } = await supabase.rpc('is_driver_active', { p_phone: phone });
      if (error) throw error;
      return !!data;
    }catch(e){
      console.warn("is_driver_active error:", e);
      // si Supabase down => on ne bloque pas à tort, on renvoie sur login
      return null; // inconnu
    }
  }

  (async function boot(){
    const phone = getPhone();

    // pas loggé => login
    if (!phone){
      location.replace(BASE + "/authentification-chauffeur.html");
      return;
    }

    const ok = await isActive(phone);

    // si statut inconnu => on renvoie sur dashboard (ou login) au choix
    if (ok === null){
      location.replace(BASE + "/courses.html");
      return;
    }

    // pas actif => paiement
    if (!ok){
      // on passe le phone en querystring pour pré-remplir côté paiement si tu veux
      location.replace(PAY_URL + "?phone=" + encodeURIComponent(phone) + "&from=" + encodeURIComponent(location.href));
      return;
    }

    // actif => dashboard
    location.replace(BASE + "/courses.html");
  })();

})();
</script>
</body>
</html>
