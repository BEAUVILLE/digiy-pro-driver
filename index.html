<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY DRIVER PRO ‚Äî VTC 0% Commission</title>
  <meta name="theme-color" content="#061b14"/>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=driver-pro-final"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.78);
      --green:#16a34a; --gold:#facc15; --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }

    #guard_status{
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 10px 14px;
      background: rgba(0,0,0,.88);
      color:#fff;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      z-index: 9999;
      border: 1px solid rgba(255,255,255,.10);
    }

    .app{display:none;}
    html.access-ok .app{display:block;}

    .wrap{
      max-width:760px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:28px;
      box-shadow:0 14px 44px rgba(0,0,0,.35);
      width:100%;
    }

    h1{
      margin:0 0 8px;
      font-size:32px;
      letter-spacing:.2px;
      background:linear-gradient(135deg, var(--green), var(--gold));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    p{margin:0 0 14px; color:var(--muted); line-height:1.6; font-size:16px;}

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(234,255,241,.92);
      font-size:14px;
      font-weight:800;
      margin:14px 0;
      flex-wrap:wrap;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:20px;}

    a.btn, button.btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:14px 20px;
      border-radius:14px;
      font-weight:900;
      text-decoration:none;
      border:0;
      cursor:pointer;
      font-size:16px;
      flex:1;
      min-width:200px;
      transition:all .2s;
    }

    .primary{
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      color:#042012;
      box-shadow:0 4px 16px rgba(34,197,94,.30);
    }
    .primary:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(34,197,94,.40);}

    .secondary{
      background:rgba(250,204,21,.14);
      border:1px solid rgba(250,204,21,.25);
      color:var(--text);
    }
    .secondary:hover{background:rgba(250,204,21,.20); border-color:rgba(250,204,21,.40);}

    .ghost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      color:var(--text);
    }
    .ghost:hover{background:rgba(255,255,255,.12);}

    .hr{height:1px; background:rgba(255,255,255,.12); margin:20px 0;}

    .note{
      margin-top:14px;
      font-size:13px;
      color:rgba(234,255,241,.76);
      line-height:1.6;
      padding:12px;
      background:rgba(0,0,0,.20);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
    }

    /* =========================================================
       ‚úÖ VIEWER IFRAME (cockpit -> g√©n√©rateur fiche)
    ========================================================= */
    .module-viewer{
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(250,204,21,.12), transparent 55%),
        var(--bg);
      z-index: 9998;
      display:flex;
      flex-direction:column;
    }
    .module-viewer.hidden{display:none;}
    .viewer-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
    }
    .viewer-topbar .title{
      font-weight:900;
      letter-spacing:.2px;
      color:rgba(234,255,241,.92);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .viewer-topbar .actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .viewer-topbar button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .viewer-topbar button:hover{background:rgba(255,255,255,.12);}
    #moduleFrame{
      width:100%;
      flex:1;
      border:none;
      background:#000;
    }

    @media(max-width:640px){
      .row{flex-direction:column;}
      a.btn, button.btn{width:100%;}
    }
  </style>
</head>

<body>
  <div id="guard_status">üîê V√©rification...</div>

  <div class="app">
    <div class="wrap">
      <div class="card">
        <h1>üöó DIGIY DRIVER PRO</h1>
        <p>
          Bienvenue <strong id="driverTitle">chauffeur</strong> dans ton espace professionnel.
          <strong>0% commission</strong> sur toutes tes courses.
        </p>

        <!-- ‚úÖ Pill enriched (HUB phone + slug) -->
        <div class="pill">
          ‚úÖ <span id="userPhone">+221‚Ä¶</span>
          <span id="pillSep1">‚Ä¢</span>
          <span id="pillSlug">Lieu : ‚Äî</span>
          <span id="pillSep2">‚Ä¢</span>
          <span>Abonnement actif</span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <a class="btn primary" data-go="./driver-zone-now.html" href="#">üöó Entrer dans la zone</a>
          <a class="btn secondary" data-go="./courses.html" href="#">üìã Voir les courses</a>
          <a class="btn secondary" data-go="./profil-chauffeur.html" href="#">üë§ Mon profil</a>
          <a class="btn secondary" data-go="./mes-lieux.html" href="#">üìç Mes lieux</a>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn secondary" id="btnGenerator" type="button">üßæ G√©n√©rer ma fiche</button>
          <button class="btn secondary" id="btnMakeTest" type="button">‚ûï Course test</button>
          <button class="btn ghost" id="btnLogout" type="button">üö™ Me d√©connecter</button>
        </div>

        <div class="note">
          <strong>üì¶ Ton abonnement DRIVER PRO</strong><br>
          ‚Ä¢ Prix : <strong>9,900 FCFA / mois</strong><br>
          ‚Ä¢ Paiement : <strong>Wave</strong><br>
          ‚Ä¢ Commission : <strong>0%</strong> (tu gardes 100%)<br>
          ‚Ä¢ Support : <strong>JB BEAUVILLE</strong> ‚Äî WhatsApp <strong>+221 77 134 28 89</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       ‚úÖ VIEWER OVERLAY (IFRAME)
  ========================================================== -->
  <div id="moduleViewer" class="module-viewer hidden" aria-hidden="true">
    <div class="viewer-topbar">
      <div class="title">üßæ G√©n√©rateur ‚Äî Fiche Chauffeur</div>
      <div class="actions">
        <button type="button" id="btnViewerClose">‚Üê Retour cockpit</button>
      </div>
    </div>
    <iframe id="moduleFrame" title="DIGIY DRIVER ‚Äî G√©n√©rateur"></iframe>
  </div>

  <script>
  /* =========================================================
     ‚úÖ HUB PHONE PASS + NAV SAFE
     - On r√©cup√®re ?phone=... (venant du HUB ROYAL)
     - On le conserve (sessionStorage) pour les pages suivantes
     - On ajoute ?phone=... sur tous les data-go (comme LOC PRO)
  ========================================================= */
  (function(){
    "use strict";

    function normPhone(p){
      if(!p) return "";
      let s = String(p).trim();
      s = s.replace(/[^\d+]/g, "");
      if (s && !s.startsWith("+")) {
        if (s.startsWith("221")) s = "+" + s;
      }
      return s;
    }

    function getUrlParam(name){
      try{
        return (new URL(location.href)).searchParams.get(name) || "";
      }catch(_){}
      return "";
    }

    const HUB_PHONE = normPhone(getUrlParam("phone"));
    if (HUB_PHONE) {
      try { sessionStorage.setItem("DIGIY_DRIVER_HUB_PHONE", HUB_PHONE); } catch(_){}
      window.DIGIY_DRIVER_HUB_PHONE = HUB_PHONE;
    } else {
      try { window.DIGIY_DRIVER_HUB_PHONE = sessionStorage.getItem("DIGIY_DRIVER_HUB_PHONE") || ""; } catch(_){}
    }

    function withPhoneParam(target){
      const phone = window.DIGIY_DRIVER_HUB_PHONE || "";
      if(!phone) return target;
      try{
        const u = new URL(target, location.href);
        if(!u.searchParams.get("phone")) u.searchParams.set("phone", phone);
        // relative if same origin
        if (u.origin === location.origin) return u.pathname + u.search + u.hash;
        return u.toString();
      }catch(_){
        const sep = target.includes("?") ? "&" : "?";
        return target + sep + "phone=" + encodeURIComponent(phone);
      }
    }

    function go(target, mode){
      const t = withPhoneParam(target);
      try{
        if(window.DIGIY_GUARD?.go) return window.DIGIY_GUARD.go(t, mode || "assign");
      }catch(_){}
      // fallback with slug (guard) then phone
      const base = (window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(t) : t);
      if((mode||"assign")==="replace") location.replace(base);
      else location.href = base;
    }

    function bindNav(){
      document.querySelectorAll("[data-go]").forEach((el)=>{
        if(el.__digiy_go_bound) return;
        el.__digiy_go_bound = true;
        el.addEventListener("click", (e)=>{
          e.preventDefault();
          const target = (el.getAttribute("data-go") || "").trim();
          const mode = (el.getAttribute("data-mode") || "assign").trim();
          if(!target) return;
          go(target, mode);
        });
      });
    }

    bindNav();
    const mo = new MutationObserver(()=>bindNav());
    mo.observe(document.documentElement, { childList:true, subtree:true });

    window.DIGIY_NAV = { go };
  })();
  </script>

  <script>
  /* =========================================================
     ‚úÖ COCKPIT VIEWER : OUVRIR / FERMER IFRAME
     - On injecte slug + phone sur l'URL de l'iframe (important)
  ========================================================= */
  (function(){
    "use strict";

    const viewer = document.getElementById("moduleViewer");
    const frame  = document.getElementById("moduleFrame");

    function withPhone(url){
      const p = window.DIGIY_DRIVER_HUB_PHONE || "";
      if(!p) return url;
      try{
        const u = new URL(url, location.href);
        if(!u.searchParams.get("phone")) u.searchParams.set("phone", p);
        if (u.origin === location.origin) return u.pathname + u.search + u.hash;
        return u.toString();
      }catch(_){
        const sep = url.includes("?") ? "&" : "?";
        return url + sep + "phone=" + encodeURIComponent(p);
      }
    }

    function openViewer(src, title){
      if(!viewer || !frame) return;

      // slug first, then phone
      const withSlug = (window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug(src) : src);
      const safeSrc = withPhone(withSlug);

      frame.src = safeSrc;

      const titleEl = viewer.querySelector(".viewer-topbar .title");
      if(titleEl && title) titleEl.textContent = title;

      viewer.classList.remove("hidden");
      viewer.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeViewer(){
      if(!viewer || !frame) return;
      frame.src = "";
      viewer.classList.add("hidden");
      viewer.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    window.DIGIY_VIEWER = { openViewer, closeViewer };

    document.getElementById("btnViewerClose")?.addEventListener("click", closeViewer);

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && !viewer.classList.contains("hidden")) closeViewer();
    });
  })();
  </script>

  <script>
  (async () => {
    const MODULE = "driver";
    const PAY_URL = "https://beauville.github.io/commencer-a-payer/"; // page paiement

    const gs = document.getElementById("guard_status");

    function getUrlParam(name){
      try{ return (new URL(location.href)).searchParams.get(name) || ""; }catch(_){}
      return "";
    }

    // ‚úÖ Guard pr√™t ?
    if(!window.DIGIY_GUARD || typeof window.DIGIY_GUARD.boot !== "function"){
      if(gs) gs.textContent = "‚ùå guard.js non charg√©";
      return;
    }

    // ‚úÖ BOOT GUARD (checkSubscription=true => paywall actif)
    const guardRes = await window.DIGIY_GUARD.boot({
      module: MODULE,
      dashboard: "./index.html",
      login: "./pin.html",
      pay: PAY_URL,
      requireSlug: true,
      checkSubscription: true
    });

    if(!guardRes?.ok){
      if(gs) gs.textContent = "‚ùå Acc√®s refus√©";
      return;
    }

    const session = window.DIGIY_GUARD.getSession?.() || null;
    if(!session?.owner_id){
      if(gs) gs.textContent = "‚ùå Session invalide";
      const pinUrl = window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug("./pin.html") : "./pin.html";
      location.replace(pinUrl);
      return;
    }

    // ‚úÖ afficher app
    document.documentElement.classList.add("access-ok");

    // ‚úÖ status badge
    if (gs) {
      gs.textContent = "‚úÖ Connect√©";
      setTimeout(() => gs.style.display = "none", 700);
    }

    // ‚úÖ slug + phone (HUB) display
    const slug = window.DIGIY_GUARD.getSlug?.() || getUrlParam("slug") || "";
    const pillSlug = document.getElementById("pillSlug");
    if (pillSlug) pillSlug.textContent = "Lieu : " + (slug || "‚Äî");

    const hubPhone = window.DIGIY_DRIVER_HUB_PHONE || "";
    const phoneEl = document.getElementById("userPhone");
    if (phoneEl) phoneEl.textContent = session.phone || hubPhone || "+221‚Ä¶";

    const titleEl = document.getElementById("driverTitle");
    if (titleEl) titleEl.textContent = session.title || session.business_name || "chauffeur";

    // ‚úÖ OUVRIR G√âN√âRATEUR (dans le cockpit)
    document.getElementById("btnGenerator")?.addEventListener("click", () => {
      const gen = "./generateur%20digiy%20driver.html";
      window.DIGIY_VIEWER?.openViewer(gen, "üßæ G√©n√©rateur ‚Äî Fiche Chauffeur");
    });

    // ‚úÖ Course test ‚Üí ouvre courses.html?make_test=1 (+slug +phone)
    document.getElementById("btnMakeTest")?.addEventListener("click", () => {
      if (!confirm("Cr√©er une course test maintenant fr√©rot ?")) return;
      const target = new URL("./courses.html", location.href);
      target.searchParams.set("make_test", "1");
      if (slug) target.searchParams.set("slug", slug);
      if (hubPhone) target.searchParams.set("phone", hubPhone);
      location.href = target.toString();
    });

    // ‚úÖ logout
    document.getElementById("btnLogout")?.addEventListener("click", () => {
      if (!confirm("Tu veux vraiment te d√©connecter fr√©rot ?")) return;
      const pinUrl = window.DIGIY_GUARD?.withSlug ? window.DIGIY_GUARD.withSlug("./pin.html") : "./pin.html";
      window.DIGIY_GUARD.logout(pinUrl);
    });
  })();
  </script>
</body>
</html>
