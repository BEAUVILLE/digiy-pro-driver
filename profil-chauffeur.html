<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER ‚Äî Profil chauffeur</title>
  <meta name="theme-color" content="#F8FAF6" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#F8FAF6; --card:#fff; --line:#E5E7EB;
      --text:#111827; --muted:#6B7280;
      --gold:#EAB308; --green:#16A34A; --danger:#EF4444;
      --radius:20px; --shadow:0 12px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(234,179,8,.18), transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, rgba(245,158,11,.15), transparent 55%),
        var(--bg);
      min-height:100vh; display:grid; place-items:center; padding:16px;
    }
    .card{
      width:min(560px, 94vw);
      border:1px solid var(--line); border-radius:var(--radius);
      background:var(--card); box-shadow:var(--shadow); padding:16px;
    }
    .brand{display:flex; gap:12px; align-items:center; justify-content:space-between}
    .left{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;display:grid;place-items:center;
      border:1px solid var(--line);
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);
      color:#92400E;font-weight:950;font-size:20px;
    }
    h1{margin:0;font-size:18px}
    .sub{margin:4px 0 0;color:var(--muted);font-weight:650}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); border-radius:999px;
      padding:7px 10px; background:#F9FAFB; font-weight:900; font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:#94a3b8}
    .dot.ok{background:var(--green)}
    .dot.bad{background:var(--danger)}
    label{display:block;margin:12px 0 8px;font-weight:950}
    input{
      width:100%;border:1px solid var(--line);border-radius:16px;
      padding:12px 12px;font-size:15px;background:#fff;outline:none;
    }
    input:focus{border-color:#FDE68A;box-shadow:0 0 0 4px rgba(234,179,8,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
      flex:1;
      border:0;border-radius:16px;padding:12px 14px;min-height:44px;
      font-weight:950;cursor:pointer;
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);color:#78350F;
    }
    .btn.ghost{
      background:#F9FAFB;color:#374151;border:1px solid var(--line);
      font-weight:900;
    }
    .btn.danger{
      background:#fff;border:1px solid rgba(239,68,68,.30);
      color:#7f1d1d;
    }
    .msg{
      margin-top:12px;padding:12px;border-radius:16px;border:1px solid var(--line);
      background:#F9FAFB;color:var(--muted);font-weight:800;line-height:1.25;
      white-space:pre-wrap;
    }
    .msg.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d}
    .msg.bad{border-color:rgba(239,68,68,.22); background:rgba(239,68,68,.06); color:#7f1d1d}
    .toggle{
      display:flex;align-items:center;justify-content:space-between;
      border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;margin-top:12px;
      font-weight:950;
    }
    .switch{
      width:54px;height:32px;border-radius:999px;border:1px solid var(--line);
      background:#e5e7eb; position:relative; cursor:pointer;
    }
    .knob{
      width:26px;height:26px;border-radius:50%; background:#fff; position:absolute; top:2px; left:2px;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
      transition:transform .18s ease;
    }
    .switch.on{background:rgba(22,163,74,.20); border-color:rgba(22,163,74,.35)}
    .switch.on .knob{transform:translateX(22px)}
  </style>
</head>

<body>
  <div class="card">
    <div class="brand">
      <div class="left">
        <div class="logo">‚àû</div>
        <div>
          <h1>Profil chauffeur</h1>
          <div class="sub" id="sub">Chargement‚Ä¶</div>
        </div>
      </div>
      <div class="pill" id="pill"><span class="dot"></span> V√©rification‚Ä¶</div>
    </div>

    <div class="toggle">
      <span>Disponibilit√©</span>
      <div class="switch" id="sw"><div class="knob"></div></div>
    </div>

    <label>Nom complet</label>
    <input id="full_name" placeholder="Ex: Lamine Ndiaye" />

    <div class="row">
      <div>
        <label>V√©hicule</label>
        <input id="car_model" placeholder="Ex: Toyota Yaris" />
      </div>
      <div>
        <label>Immatriculation</label>
        <input id="car_plate" placeholder="Ex: DK-1234-AB" />
      </div>
    </div>

    <label>Ville (optionnel)</label>
    <input id="city" placeholder="Ex: Dakar / Saly" />

    <div class="btnRow">
      <button class="btn" id="btnSave" type="button">üíæ Enregistrer</button>
      <button class="btn ghost" id="btnCourses" type="button">üöó Mes courses</button>
      <button class="btn danger" id="btnLogout" type="button">‚èè D√©connexion</button>
    </div>

    <div class="msg" id="msg">‚Äî</div>
  </div>

<script>
(function(){
  'use strict';

  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const MODULE = "driver";

  const $ = (id)=>document.getElementById(id);
  const msg = $("msg");
  const pill = $("pill");
  const sub = $("sub");

  function setMsg(t, kind=""){
    msg.className = "msg" + (kind ? " " + kind : "");
    msg.textContent = t;
  }
  function setPill(t, kind=""){
    pill.innerHTML = `<span class="dot ${kind||""}"></span> ${t}`;
  }

  function normPhone(p){
    p = (p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function getPhone(){
    const s = sessionStorage.getItem("digiy_driver_phone");
    if(s) return normPhone(s);
    try{
      const a = JSON.parse(localStorage.getItem("digiy_driver_access_pin")||"null");
      return a?.phone ? normPhone(a.phone) : null;
    }catch(_){}
    return null;
  }

  function getAccess(){
    try{ return JSON.parse(localStorage.getItem("digiy_driver_access_pin") || "null"); }
    catch(e){ return null; }
  }

  function setBridge(phone){
    sessionStorage.setItem("digiy_driver_ok","1");
    sessionStorage.setItem("digiy_driver_phone", phone);
  }

  function clearBridge(){
    sessionStorage.removeItem("digiy_driver_ok");
    sessionStorage.removeItem("digiy_driver_phone");
  }

  // ‚úÖ Supabase unique
  window.__sb = window.__sb || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const supabase = window.__sb;

  let driverPhone = null;
  let isOnline = false;

  function applySwitch(){
    const sw = $("sw");
    sw.classList.toggle("on", !!isOnline);
  }
  function setOnline(v){
    isOnline = !!v;
    applySwitch();
  }

  async function guardPin(){
    const phone = getPhone();
    const access = getAccess();
    const pin = String(access?.pin || "").trim();

    if(!phone || !pin){
      setPill("Session absente", "bad");
      sub.textContent = "Reconnecte-toi";
      setMsg("‚ö†Ô∏è Pas de session PIN. Retour auth.", "bad");
      setTimeout(()=> location.href="./authentification-chauffeur.html", 350);
      return false;
    }

    const { data, error } = await supabase.rpc("verify_access_pin", {
      p_phone: phone, p_pin: pin, p_module: MODULE
    });

    if(error || !data){
      setPill("Session invalide", "bad");
      sub.textContent = "Reconnecte-toi";
      setMsg("‚ùå Session expir√©e / refus√©e.", "bad");
      setTimeout(()=> location.href="./authentification-chauffeur.html", 350);
      return false;
    }

    driverPhone = phone;
    setBridge(phone);
    setPill("OK", "ok");
    sub.textContent = "T√©l√©phone: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + phone.slice(-4);
    return true;
  }

  async function loadProfile(){
    const { data, error } = await supabase
      .from("driver_profiles")
      .select("*")
      .eq("phone", driverPhone)
      .maybeSingle();

    if(error){
      setMsg("‚ùå Erreur load profil:\n" + error.message, "bad");
      return;
    }

    // profil inexistant ‚Üí valeurs par d√©faut
    $("full_name").value = data?.full_name || "";
    $("car_model").value = data?.car_model || "";
    $("car_plate").value = data?.car_plate || "";
    $("city").value = data?.city || (localStorage.getItem("digiy_driver_city") || "");
    setOnline(!!data?.is_online);

    setMsg(data ? "‚úÖ Profil charg√©." : "üü° Pas de profil encore. Remplis puis Enregistrer.", data ? "ok" : "");
  }

  async function saveProfile(){
    const payload = {
      phone: driverPhone,
      full_name: ($("full_name").value || "").trim(),
      car_model: ($("car_model").value || "").trim(),
      car_plate: ($("car_plate").value || "").trim(),
      city: ($("city").value || "").trim() || null,
      is_online: !!isOnline,
      updated_at: new Date().toISOString()
    };

    // garde la ville en local pour courses.html
    if(payload.city) localStorage.setItem("digiy_driver_city", payload.city);

    const { error } = await supabase
      .from("driver_profiles")
      .upsert(payload, { onConflict: "phone" });

    if(error){
      setMsg("‚ùå Erreur save:\n" + error.message, "bad");
      return;
    }

    setMsg("‚úÖ Profil enregistr√©.", "ok");
  }

  $("sw").addEventListener("click", ()=> setOnline(!isOnline));

  $("btnSave").addEventListener("click", async ()=>{
    if(!driverPhone){ setMsg("Session invalide.", "bad"); return; }
    setMsg("‚è≥ Enregistrement‚Ä¶", "");
    await saveProfile();
  });

  $("btnCourses").addEventListener("click", ()=> location.href="./courses.html");

  $("btnLogout").addEventListener("click", ()=>{
    localStorage.removeItem("digiy_driver_access_pin");
    clearBridge();
    location.href="./authentification-chauffeur.html";
  });

  (async ()=>{
    setPill("V√©rification‚Ä¶", "");
    setMsg("‚Ä¶", "");
    const ok = await guardPin();
    if(!ok) return;
    await loadProfile();
  })();
})();
</script>
</body>
</html>
