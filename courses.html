<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mes Courses ‚Äî DIGIY DRIVER PRO</title>
  <meta name="theme-color" content="#061b14"/>

  <!-- Supabase + Guard -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=driver-20260208-rpc1"></script>

  <style>
    :root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--green:#16a34a;--gold:#facc15;--r:18px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(6,27,20,.75);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-weight:900;letter-spacing:.2px;font-size:18px}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted);background:rgba(0,0,0,.22);display:flex;gap:8px;align-items:center;white-space:nowrap}
    main{padding:16px;max-width:980px;margin:0 auto}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.32)}
    @media(min-width:860px){.card.half{grid-column:span 6}}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.45}
    button,a.btn{border:0;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;font-size:15px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012}
    .btn2{background:rgba(250,204,21,.14);color:var(--text);border:1px solid rgba(250,204,21,.25)}
    .btnGhost{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--line)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted);font-size:13px}
    .list{margin-top:10px;display:grid;gap:10px}
    .item{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:12px;align-items:flex-start;transition:all .2s}
    .item:hover{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.08);transform:translateY(-2px)}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;white-space:nowrap;font-weight:900}
    .tag.new{border:1px solid rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:rgba(234,255,241,.92)}
    .tag.soon{border:1px solid rgba(250,204,21,.35);background:rgba(250,204,21,.12);color:rgba(254,243,199,.92)}
    .tag.planned{border:1px solid rgba(59,130,246,.35);background:rgba(59,130,246,.12);color:rgba(191,219,254,.92)}
    .tag.done{border:1px solid rgba(148,163,184,.35);background:rgba(148,163,184,.12);color:#e5e7eb}
    .tag.cancel{border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fecaca}
    .empty{border:2px dashed rgba(255,255,255,.14);border-radius:16px;padding:18px;text-align:center;color:var(--muted)}
    code{font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#bbf7d0}
    .warn{margin-top:10px;padding:12px;border-radius:14px;border:1px solid rgba(250,204,21,.25);background:rgba(250,204,21,.10);color:#fde68a;font-weight:800}
    .ok{margin-top:10px;padding:12px;border-radius:14px;border:1px solid rgba(34,197,94,.25);background:rgba(34,197,94,.10);color:#bbf7d0;font-weight:800}
    .itemActions{display:flex;flex-direction:column;gap:8px;align-items:flex-end;min-width:150px}
    .mini{padding:10px 12px;border-radius:12px;font-weight:900;font-size:14px}
    .mini.accept{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012;border:0}
    .mini.disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>

<body>
<header>
  <div class="title">üöó Mes Courses</div>
  <div class="pill" id="pillPhone">üì± ‚Ä¶</div>
</header>

<main>
  <div class="grid">
    <section class="card half">
      <h1 id="headline">T'es en ligne fr√©rot ! ü¶Ö</h1>
      <p id="status">Chargement‚Ä¶</p>

      <div class="row">
        <button class="btn" id="btnRefresh">üîÑ Actualiser</button>
        <a class="btnGhost" id="btnDashboard" href="./index.html">üè† Dashboard</a>
        <button class="btn2" id="btnLogout">üö™ Me d√©connecter</button>
      </div>

      <p class="muted" style="margin-top:10px">
        Session: <code>8h</code> ‚Ä¢ Slug: <code id="slugBox">‚Äî</code> ‚Ä¢ Owner: <code id="ownerBox">‚Äî</code>
      </p>

      <div id="debug" class="muted" style="margin-top:10px"></div>
    </section>

    <section class="card half">
      <h1>Tes courses üî•</h1>
      <p class="muted">On charge via RPC (terrain safe) : token maison (pas de d√©pendance auth.uid).</p>
      <div class="list" id="list"></div>
    </section>

    <section class="card">
      <h1>Comment √ßa marche</h1>
      <p>
        ‚úÖ Tu te connectes par PIN<br>
        ‚úÖ Ton cockpit maintient la pr√©sence via <b>driver_heartbeat_pro</b><br>
        ‚úÖ Cette page charge les courses via RPC + slug<br>
        ‚úÖ Prochain step : matching zone + acceptation 1 clic
      </p>
    </section>
  </div>
</main>

<script>
(async()=>{
  const statusEl = document.getElementById("status");
  const pillPhone = document.getElementById("pillPhone");
  const listEl = document.getElementById("list");
  const slugBox = document.getElementById("slugBox");
  const ownerBox = document.getElementById("ownerBox");
  const debugEl = document.getElementById("debug");

  // ‚úÖ Guard session
  const session = window.DIGIY_GUARD?.requireSession?.("./pin.html");
  if(!session) return;

  // ‚úÖ token maison (doit √™tre stock√© par guard au login)
  const token = window.DIGIY_GUARD.getDriverToken?.() || "";

  const url = new URL(location.href);
  const slug = (url.searchParams.get("slug") || session.slug || "").trim().toLowerCase();

  slugBox.textContent = slug || "‚Äî";
  ownerBox.textContent = (session.owner_id || "‚Äî");

  // dashboard conserve slug
  const dash = new URL("./index.html", location.href);
  if(slug) dash.searchParams.set("slug", slug);
  document.getElementById("btnDashboard").href = dash.toString();

  pillPhone.textContent = "üì± " + (session.phone || session.slug || "Connect√©");
  statusEl.textContent = `‚úÖ Connect√© ${session.title || "chauffeur"} ü¶Ö`;

  // Supabase client
  const sb = window.DIGIY_GUARD.getSb();

  function escapeHtml(str){
    const d = document.createElement("div");
    d.textContent = String(str ?? "");
    return d.innerHTML;
  }

  function fmtWhen(t){
    if(!t) return "‚Äî";
    try{
      const d = new Date(t);
      return d.toLocaleString("fr-FR", { dateStyle:"medium", timeStyle:"short" });
    }catch{ return String(t); }
  }

  function tagFromTrip(tr){
    if(tr.cancelled_at) return {cls:"cancel", label:"‚ùå Annul√©e"};
    if(tr.completed_at) return {cls:"done", label:"‚úÖ Termin√©e"};
    if(tr.accepted_at) return {cls:"new", label:"üü¢ Accept√©e"};
    if(tr.scheduled_at) return {cls:"planned", label:"üìÖ Programm√©e"};
    return {cls:"soon", label:"‚è∞ √Ä venir"};
  }

  function getVilleFromSlug(slug){
    const s = (slug || "").toLowerCase();
    if (s.includes("saly")) return "Saly";
    if (s.includes("mbour")) return "Mbour";
    if (s.includes("somone")) return "Somone";
    if (s.includes("ngaparou")) return "Ngaparou";
    return slug || null;
  }

  // ‚úÖ Presence PRO (heartbeat)
  async function heartbeatPro(){
    if(!token) return;
    try{
      await window.DIGIY_GUARD.rpc("driver_heartbeat_pro", {
        p_token: token,
        p_display_name: session.title || "chauffeur",
        p_driver_phone: session.phone || null,
        p_ville: getVilleFromSlug(slug)
      });
    }catch(_){}
  }
  heartbeatPro();
  setInterval(heartbeatPro, 25000);
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) heartbeatPro(); });
  window.addEventListener("focus", heartbeatPro);

  // ‚úÖ Accept offer (token) ‚Äî n√©cessite offer_id dans les rows
  async function acceptOffer(offerId){
    if(!token){
      debugEl.className = "warn";
      debugEl.textContent = "‚ö†Ô∏è Token manquant. Reconnecte-toi (PIN) pour g√©n√©rer le token.";
      return;
    }
    if(!offerId){
      debugEl.className = "warn";
      debugEl.textContent = "‚ö†Ô∏è Offer ID manquant (la RPC ne renvoie pas offer_id).";
      return;
    }

    try{
      debugEl.className = "warn";
      debugEl.textContent = "‚è≥ Acceptation en cours‚Ä¶";

      const { data, error } = await sb.rpc("accept_offer_pro", {
        p_token: token,
        p_offer_id: offerId
      });
      if(error) throw error;

      if(!data?.ok){
        debugEl.className = "warn";
        debugEl.textContent = "‚ö†Ô∏è Refus: " + (data?.error || "inconnu");
        return;
      }

      debugEl.className = "ok";
      debugEl.textContent = "‚úÖ Course accept√©e !";
      await loadTrips();
    }catch(e){
      debugEl.className = "warn";
      debugEl.textContent = "‚ö†Ô∏è Acceptation KO: " + (e?.message || "inconnu");
    }
  }

  function renderTrips(rows){
    if(!rows || !rows.length){
      const demo = [
        {
          id:"DEMO-1001",
          pickup_city:"Saly",
          pickup_zone:"Saly Centre",
          dropoff_city:"Ngaparou",
          dropoff_zone:"Route principale",
          amount:2500,
          scheduled_at:new Date().toISOString()
        },
        {
          id:"DEMO-1002",
          pickup_city:"Somone",
          pickup_zone:"Lagune",
          dropoff_city:"Saly",
          dropoff_zone:"Nianing",
          proposed_price:3500,
          scheduled_at:new Date(Date.now()+30*60*1000).toISOString()
        },
        {
          id:"DEMO-1003",
          pickup_city:"AIBD",
          pickup_zone:"Arriv√©es",
          dropoff_city:"Dakar",
          dropoff_zone:"Plateau",
          amount:15000,
          scheduled_at:new Date(Date.now()+24*60*60*1000).toISOString()
        }
      ];

      listEl.innerHTML = `
        <div class="empty">
          Aucune course trouv√©e pour l‚Äôinstant fr√©rot.<br><br>
          <span class="muted">En attendant, voil√† 3 d√©mos (le live arrive).</span>
        </div>
        <div style="height:10px"></div>
      ` + demo.map(tr=>{
        const from = [tr.pickup_city, tr.pickup_zone].filter(Boolean).join(" ‚Ä¢ ");
        const to   = [tr.dropoff_city, tr.dropoff_zone].filter(Boolean).join(" ‚Ä¢ ");
        const when = tr.scheduled_at;
        const amount = (tr.amount!=null) ? `${tr.amount} FCFA` : (tr.proposed_price!=null ? `${tr.proposed_price} FCFA` : "‚Äî");
        return `
          <div class="item">
            <div>
              <div style="font-weight:900">${escapeHtml(tr.id)} ‚Äî ${escapeHtml(from)} ‚Üí ${escapeHtml(to)}</div>
              <div class="muted">${escapeHtml(fmtWhen(when))} ‚Ä¢ ${escapeHtml(amount)}</div>
            </div>
            <div class="tag soon">‚è∞ √Ä venir</div>
          </div>
        `;
      }).join("");

      return;
    }

    listEl.innerHTML = rows.map(tr=>{
      const tag = tagFromTrip(tr);
      const from = [tr.pickup_city, tr.pickup_zone].filter(Boolean).join(" ‚Ä¢ ") || "D√©part";
      const to   = [tr.dropoff_city, tr.dropoff_zone].filter(Boolean).join(" ‚Ä¢ ") || "Arriv√©e";
      const when = tr.scheduled_at || tr.created_at || tr.updated_at;
      const idShort = (tr.id||"").toString().slice(0,8).toUpperCase();
      const amount = (tr.amount!=null) ? `${tr.amount} FCFA` : (tr.proposed_price!=null ? `${tr.proposed_price} FCFA` : "‚Äî");

      // ‚úÖ on supporte plusieurs noms possibles venant de la RPC
      const offerId = tr.offer_id || tr.current_offer_id || tr.active_offer_id || null;
      const offerStatus = (tr.offer_status || tr.offer_state || "").toString().toLowerCase();

      const canAccept = !!offerId && (offerStatus === "sent" || offerStatus === "viewed" || offerStatus === "offered" || offerStatus === "");

      return `
        <div class="item">
          <div>
            <div style="font-weight:900">${escapeHtml(idShort)} ‚Äî ${escapeHtml(from)} ‚Üí ${escapeHtml(to)}</div>
            <div class="muted">${escapeHtml(fmtWhen(when))} ‚Ä¢ ${escapeHtml(amount)}</div>
            ${offerId ? `<div class="muted">Offer: <code>${escapeHtml(String(offerId))}</code></div>` : ``}
          </div>

          <div class="itemActions">
            <div class="tag ${escapeHtml(tag.cls)}">${escapeHtml(tag.label)}</div>
            ${canAccept ? `<button class="mini accept" data-accept="${escapeHtml(String(offerId))}">‚úÖ Accepter</button>` : ``}
          </div>
        </div>
      `;
    }).join("");

    // bind accept buttons
    listEl.querySelectorAll("[data-accept]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const offerId = e.currentTarget.getAttribute("data-accept");
        if(!offerId) return;
        if(!confirm("Accepter cette course maintenant ?")) return;
        await acceptOffer(offerId);
      });
    });
  }

  // ‚úÖ Create test trip when ?make_test=1
  async function maybeCreateTestTrip(){
    const want = url.searchParams.get("make_test");
    if(want !== "1") return false;

    // √©vite re-create au refresh
    url.searchParams.delete("make_test");
    history.replaceState(null, "", url.toString());

    try{
      debugEl.className = "warn";
      debugEl.textContent = "‚è≥ Cr√©ation course test...";

      const { data, error } = await sb.rpc("digiy_driver_trip_create_test", {
        p_driver_slug: slug,
        p_owner_id: session.owner_id
      });

      if(error) throw error;

      debugEl.className = "ok";
      debugEl.textContent = "‚úÖ Course test cr√©√©e: " + String(data || "OK");
      return true;

    }catch(e){
      console.warn("‚ùå CREATE test trip KO:", e);
      debugEl.className = "warn";
      debugEl.textContent = "‚ö†Ô∏è Course test refus√©e (RPC). D√©tail: " + (e?.message || "inconnu");
      return false;
    }
  }

  async function loadTrips(){
    await maybeCreateTestTrip();

    try{
      const { data, error } = await sb.rpc("digiy_driver_trips_list", {
        p_driver_slug: slug,
        p_owner_id: session.owner_id,
        p_limit: 30
      });

      if(error) throw error;

      renderTrips(data || []);

      if(!debugEl.textContent || debugEl.className === "muted"){
        debugEl.className = "ok";
        debugEl.textContent = token
          ? "‚úÖ LIVE via RPC digiy_driver_trips_list + token OK."
          : "‚úÖ LIVE via RPC digiy_driver_trips_list (mais token manquant).";
      }

    }catch(e){
      console.warn("‚ùå RPC list trips KO:", e);
      renderTrips([]);
      debugEl.className = "warn";
      debugEl.textContent = "‚ö†Ô∏è Impossible de charger les courses via RPC. D√©tail: " + (e?.message || "inconnu");
    }
  }

  document.getElementById("btnRefresh").addEventListener("click", loadTrips);

  document.getElementById("btnLogout").addEventListener("click", ()=>{
    if(confirm("Tu veux vraiment te d√©connecter fr√©rot ?")){
      window.DIGIY_GUARD.logout("./pin.html");
    }
  });

  // GO
  await loadTrips();
})();
</script>
</body>
</html>
