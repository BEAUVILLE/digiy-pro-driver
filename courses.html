<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mes Courses ‚Äî DIGIY DRIVER PRO</title>
  <meta name="theme-color" content="#061b14"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js"></script>

  <style>
    :root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--r:18px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(6,27,20,.75);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-weight:900;font-size:18px}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted);background:rgba(0,0,0,.22);display:inline-flex;gap:8px;align-items:center;white-space:nowrap}
    a.pill{text-decoration:none}
    main{padding:16px;max-width:980px;margin:0 auto}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.32)}
    @media(min-width:860px){.card.half{grid-column:span 6}}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.45}
    button{border:0;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;font-size:15px}
    .btn{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012}
    .btn2{background:rgba(250,204,21,.14);color:var(--text);border:1px solid rgba(250,204,21,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted);font-size:13px}
    .list{margin-top:10px;display:grid;gap:10px}
    .item{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .left{min-width:220px}
    .topline{font-weight:1000}
    .subline{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.35}
    .right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;font-weight:900;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:rgba(234,255,241,.9)}
    .amount{font-weight:1100}
    .empty{border:2px dashed rgba(255,255,255,.14);border-radius:16px;padding:18px;text-align:center;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="title">üöó Mes Courses</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
    <a class="pill" href="./index.html">üè† Dashboard</a>
    <a class="pill" href="./driver-zone-now.html">üìç Secteurs</a>
    <a class="pill" href="./mes-lieux.html">üìå Mes lieux</a>
    <div class="pill" id="pillPhone">üì± ‚Ä¶</div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card half">
      <h1>T'es en ligne fr√©rot ! ü¶Ö</h1>
      <p id="status">Chargement‚Ä¶</p>
      <div class="row">
        <button class="btn" id="btnRefresh">üîÑ Actualiser</button>
        <button class="btn2" id="btnLogout">üö™ Me d√©connecter</button>
      </div>
      <p class="muted" style="margin-top:10px">On passe par verify_access_pin_by_slug (unique) ‚Äî plus de bug 42725.</p>
    </section>

    <section class="card half">
      <h1>Tes courses üî•</h1>
      <p class="muted" id="subInfo">LIVE : chargement‚Ä¶</p>
      <div class="list" id="list"></div>
      <div class="small" id="foot"></div>
    </section>
  </div>
</main>

<script>
(function(){
  const pillPhone=document.getElementById("pillPhone");
  const statusEl=document.getElementById("status");
  const listEl=document.getElementById("list");
  const subInfo=document.getElementById("subInfo");
  const foot=document.getElementById("foot");

  function setStatus(msg){ statusEl.textContent = msg||""; }
  function secteursActifs(){ return JSON.parse(localStorage.getItem("digiy_driver_secteurs") || "[]"); }
  function money(n){ const x=parseInt(n||0,10)||0; return x.toLocaleString("fr-FR")+" FCFA"; }
  function dt(ts){ if(!ts) return ""; return String(ts).slice(0,19).replace("T"," "); }

  function render(rows, zones){
    if(!rows || rows.length===0){
      listEl.innerHTML = `
        <div class="empty">
          <div style="font-size:42px;margin-bottom:8px">üïäÔ∏è</div>
          Aucune course pour le moment fr√©rot.
        </div>`;
      foot.textContent = zones.length ? ("Filtre secteurs: " + zones.join(", ")) : "Aucun filtre secteur (tu vois tout).";
      return;
    }
    listEl.innerHTML = rows.map(t=>{
      const pz=t.pickup_zone || t.pickup_city || "Zone";
      const dz=t.dropoff_zone || t.dropoff_city || "Destination";
      const when = dt(t.scheduled_at || t.created_at);
      const amt = money(t.amount || t.proposed_price || 0);
      const code = String(t.id||"").slice(0,8).toUpperCase();
      return `
        <div class="item">
          <div class="left">
            <div class="topline">${code} ‚Äî ${pz} ‚Üí ${dz}</div>
            <div class="subline">üïí ${when || "‚Äî"}<br>üë§ ${t.client_label || "Client"} ‚Ä¢ ${t.client_phone || ""}</div>
          </div>
          <div class="right">
            <div class="tag">${t.status || "pending"}</div>
            <div class="amount">${amt}</div>
          </div>
        </div>
      `;
    }).join("");
    foot.textContent = zones.length ? ("Filtre secteurs: " + zones.join(", ")) : "Aucun filtre secteur (tu vois tout).";
  }

  async function loadTrips(session){
    const zones = secteursActifs();
    const slug = (session.slug || "").trim();
    const pin  = (session.pin  || "").trim();

    pillPhone.textContent = "üì± " + (session.phone || slug || "Connect√©");
    subInfo.textContent = zones.length ? `Filtre actif: ${zones.length} secteur(s)` : "Aucun secteur s√©lectionn√© (affichage total).";

    if(!slug || !pin){
      setStatus("‚ö†Ô∏è slug/pin manquants. Reconnecte-toi.");
      render([], zones);
      return;
    }

    const sb = window.DIGIY_GUARD.getSb();
    if(!sb){
      setStatus("‚ùå Supabase indisponible.");
      render([], zones);
      return;
    }

    // ‚úÖ 1) V√©rif PIN via fonction UNIQUE
    setStatus("‚è≥ V√©rification acc√®s‚Ä¶");
    const { data: vData, error: vErr } = await sb.rpc("verify_access_pin_by_slug", {
      p_slug: slug,
      p_pin: pin,
      p_module: "DRIVER"
    });

    if(vErr){
      console.error("VERIFY ERROR:", vErr);
      setStatus("‚ùå Acc√®s KO: " + (vErr.message || "verify"));
      render([], zones);
      return;
    }

    const v = (typeof vData === "string") ? JSON.parse(vData) : vData;
    if(!v?.ok || !v?.owner_id){
      setStatus("‚ùå PIN invalide ou acc√®s refus√©.");
      render([], zones);
      return;
    }

    // ‚úÖ 2) Lire les courses
    // NOTE: si RLS bloque cette lecture, on fera une RPC SECURITY DEFINER (je te la donne apr√®s)
    setStatus("‚è≥ Chargement des courses‚Ä¶");
    const { data: trips, error: tErr } = await sb
      .from("driver_trips")
      .select("*")
      .eq("auth_user_id", v.owner_id)
      .order("created_at", { ascending: false })
      .limit(50);

    if(tErr){
      console.error("TRIPS ERROR:", tErr);
      setStatus("‚ùå Lecture courses bloqu√©e (RLS).");
      render([], zones);
      return;
    }

    const rows = Array.isArray(trips) ? trips : [];
    const filtered = zones.length
      ? rows.filter(t => zones.includes((t.pickup_zone || t.pickup_city || "").trim()))
      : rows;

    setStatus(`‚úÖ ${filtered.length} course(s) affich√©e(s)`);
    render(filtered, zones);
  }

  function boot(){
    const s = window.DIGIY_GUARD.requireSession("./pin.html");
    if(!s) return;
    loadTrips(s);
  }

  document.getElementById("btnRefresh").addEventListener("click",()=>boot());
  document.getElementById("btnLogout").addEventListener("click",()=>{
    confirm("Tu veux vraiment te d√©connecter fr√©rot ?") && window.DIGIY_GUARD.logout("./pin.html");
  });

  if(window.DIGIY_GUARD?.requireSession) boot();
  else window.addEventListener("DIGIY_GUARD_READY", boot);
})();
</script>
</body>
</html>
