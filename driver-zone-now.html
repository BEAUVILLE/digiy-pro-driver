<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY DRIVER ‚Äî Ma Zone Maintenant</title>
  <meta name="theme-color" content="#0A0E1A"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#070b16;
      --card:#0b1224;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --gold:#facc15;
      --green:#22c55e;
      --orange:#fb923c;
      --red:#ef4444;
      --radius:18px;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(250,204,21,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.16), transparent 55%),
        var(--bg);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 26px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin:10px 0 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:999px;
    }
    .brand .mark{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      color:#0b0b0b;
      background: linear-gradient(135deg, #fde68a, #facc15, #f59e0b);
      box-shadow: 0 10px 30px rgba(250,204,21,.22);
      font-weight:900;
    }
    .brand .t1{font-weight:900; letter-spacing:.2px}
    .brand .t2{font-size:12px; color:var(--muted); margin-top:1px}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 10px;
      font-size:15px;
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .sub{
      padding:0 14px 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .list{padding:10px 10px 12px; display:flex; flex-direction:column; gap:10px;}
    .row{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:10px;
      padding:12px;
      border:1px solid var(--line);
      background:rgba(8,12,26,.75);
      border-radius:16px;
    }
    .zname{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    .meta{
      margin-top:6px;
      display:flex; flex-wrap:wrap; gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .scoreBox{
      display:flex; flex-direction:column; align-items:flex-end; justify-content:space-between;
    }
    .score{
      font-weight:1000;
      font-size:24px;
      letter-spacing:.3px;
      color:var(--gold);
    }
    .badge{
      font-weight:800;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .badge.hot{color:#111827; background:linear-gradient(135deg,#fde68a,#facc15,#f59e0b); border-color:rgba(250,204,21,.35)}
    .badge.active{color:#062b1b; background:linear-gradient(135deg,#bbf7d0,#22c55e); border-color:rgba(34,197,94,.35)}
    .badge.mid{color:#1f1300; background:linear-gradient(135deg,#fed7aa,#fb923c); border-color:rgba(251,146,60,.35)}
    .badge.calm{color:var(--muted)}
    .rightCard{padding:14px;}
    .kpi{display:grid; gap:10px; grid-template-columns:1fr 1fr;}
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
    }
    .kpi .lab{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:6px; font-weight:1000; font-size:18px}
    .hint{
      margin-top:10px;
      border:1px dashed rgba(250,204,21,.35);
      background:rgba(250,204,21,.06);
      border-radius:16px;
      padding:12px;
      color:rgba(234,242,255,.85);
      font-size:13px;
      line-height:1.35;
    }
    .state{padding:14px; color:var(--muted); font-size:13px;}
    .err{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
      color:rgba(255,255,255,.9);
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark">‚àû</div>
        <div>
          <div class="t1">DIGIY DRIVER</div>
          <div class="t2">Ma Zone Maintenant ‚Äî score 0‚Äì100</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <a class="btn" href="./index.html">‚Üê Retour</a>
        <button class="btn" id="btnRefresh">‚Üª Actualiser</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>
          Zones chaudes (24h)
          <span class="pill" id="pillUpdated">‚è≥ Mise √† jour‚Ä¶</span>
        </h2>
        <div class="sub">
          Lecture rapide : <b>üî• tr√®s active</b>, <b>üü¢ active</b>, <b>üü° moyen</b>, <b>‚ö™ calme</b>.  
          Objectif : te montrer o√π ‚Äú√ßa bouge‚Äù, sans deviner.
        </div>

        <div class="list" id="zoneList">
          <div class="state">Chargement‚Ä¶</div>
        </div>

        <div class="state" id="stateNote" style="display:none;"></div>
        <div class="err" id="errBox" style="display:none;"></div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="rightCard">
          <h2 style="padding:0 0 10px; border:0;">
            R√©sum√©
            <span class="pill">V1</span>
          </h2>

          <div class="kpi">
            <div class="box">
              <div class="lab">Top zone</div>
              <div class="val" id="kpiTop">‚Äî</div>
            </div>
            <div class="box">
              <div class="lab">Score top</div>
              <div class="val" id="kpiScore">‚Äî</div>
            </div>
            <div class="box">
              <div class="lab">Courses total (top 5)</div>
              <div class="val" id="kpiTrips">‚Äî</div>
            </div>
            <div class="box">
              <div class="lab">Panier moyen (top)</div>
              <div class="val" id="kpiAvg">‚Äî</div>
            </div>
          </div>

          <div class="hint">
            üí° <b>Mode d√©mo</b> : la vue peut inclure des donn√©es test si vous n‚Äôavez pas encore de drivers actifs.
            Le jour du lancement, tu vides <code>driver_trips_demo</code> et tu passes en ‚Äú2h‚Äù.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ============================================================
  // üîê SUPABASE ‚Äî D√âJ√Ä POS√â (TES CL√âS)
  // ============================================================
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Vue agr√©g√©e (d√©mo-friendly)
  const VIEW = "v_driver_zone_hot_score_live";

  const zoneList = document.getElementById("zoneList");
  const pillUpdated = document.getElementById("pillUpdated");
  const btnRefresh = document.getElementById("btnRefresh");
  const errBox = document.getElementById("errBox");
  const stateNote = document.getElementById("stateNote");

  const kpiTop = document.getElementById("kpiTop");
  const kpiScore = document.getElementById("kpiScore");
  const kpiTrips = document.getElementById("kpiTrips");
  const kpiAvg = document.getElementById("kpiAvg");

  function fmtCFA(n){
    const x = Math.round(Number(n || 0));
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " CFA";
  }

  function badge(score){
    score = Number(score || 0);
    if(score >= 80) return { label:"üî• Tr√®s active", cls:"hot" };
    if(score >= 60) return { label:"üü¢ Active", cls:"active" };
    if(score >= 40) return { label:"üü° Moyen", cls:"mid" };
    return { label:"‚ö™ Calme", cls:"calm" };
  }

  function timeAgo(iso){
    if(!iso) return "‚Äî";
    const t = new Date(iso).getTime();
    const now = Date.now();
    const s = Math.max(0, Math.round((now - t)/1000));
    if(s < 60) return `il y a ${s}s`;
    const m = Math.round(s/60);
    if(m < 60) return `il y a ${m} min`;
    const h = Math.round(m/60);
    return `il y a ${h}h`;
  }

  function setLoading(){
    errBox.style.display = "none";
    stateNote.style.display = "none";
    zoneList.innerHTML = `<div class="state">Chargement‚Ä¶</div>`;
    pillUpdated.textContent = "‚è≥ Mise √† jour‚Ä¶";
  }

  function setError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
    pillUpdated.textContent = "‚ö†Ô∏è Erreur";
  }

  function render(rows){
    if(!rows || rows.length === 0){
      zoneList.innerHTML = `<div class="state">Aucune donn√©e pour le moment.</div>`;
      pillUpdated.textContent = "üü° Vide";
      kpiTop.textContent = "‚Äî";
      kpiScore.textContent = "‚Äî";
      kpiTrips.textContent = "‚Äî";
      kpiAvg.textContent = "‚Äî";
      return;
    }

    const top = rows[0];
    const tripsTop5 = rows.slice(0,5).reduce((a,r)=>a + Number(r.trips_completed_24h || 0), 0);

    kpiTop.textContent = top.zone_key || "‚Äî";
    kpiScore.textContent = `${top.hot_score_0_100}/100`;
    kpiTrips.textContent = `${tripsTop5}`;
    kpiAvg.textContent = fmtCFA(top.avg_amount_24h);

    pillUpdated.textContent = `‚úÖ Update ${timeAgo(top.last_trip_created_at)}`;

    zoneList.innerHTML = rows.slice(0,8).map(r=>{
      const b = badge(r.hot_score_0_100);
      const canc = Number(r.trips_cancelled_24h || 0);
      const tot = Number(r.trips_total_24h || 0);
      const cancelRate = tot ? Math.round((canc/tot)*100) : 0;

      return `
        <div class="row">
          <div>
            <div class="zname">
              <span>${r.zone_key || "Zone"}</span>
              <span class="badge ${b.cls}">${b.label}</span>
            </div>
            <div class="meta">
              <span>üöó ${r.trips_completed_24h} course(s) / 24h</span>
              <span>üí∞ ${fmtCFA(r.avg_amount_24h)} moy.</span>
              <span>üìç ${Number(r.avg_distance_km_24h || 0).toFixed(1)} km</span>
              <span>‚è±Ô∏è ${timeAgo(r.last_trip_created_at)}</span>
              ${canc ? `<span>‚ö†Ô∏è Annulations ${cancelRate}%</span>` : ``}
            </div>
          </div>

          <div class="scoreBox">
            <div class="score">${r.hot_score_0_100}</div>
            <div class="pill">Score</div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function load(){
    setLoading();

    const { data, error } = await SB
      .from(VIEW)
      .select("*")
      .order("hot_score_0_100", { ascending:false })
      .limit(8);

    if(error){
      setError(String(error.message || error));
      zoneList.innerHTML = `<div class="state">Impossible de charger pour l‚Äôinstant.</div>`;
      return;
    }

    render(data || []);
  }

  btnRefresh.addEventListener("click", load);
  load();
</script>
</body>
</html>
