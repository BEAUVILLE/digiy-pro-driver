<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mes Courses â€” DIGIY DRIVER PRO</title>
  <meta name="theme-color" content="#061b14"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js"></script>

  <style>
    :root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--r:18px;--green:#16a34a;--gold:#facc15}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(6,27,20,.75);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.2px;font-size:18px}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted);background:rgba(0,0,0,.22);display:inline-flex;gap:8px;align-items:center;white-space:nowrap}
    a.pill{text-decoration:none}
    main{padding:16px;max-width:980px;margin:0 auto}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.32)}
    @media(min-width:860px){.card.half{grid-column:span 6}}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.45}
    button{border:0;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;font-size:15px}
    .btn{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012}
    .btn2{background:rgba(250,204,21,.14);color:var(--text);border:1px solid rgba(250,204,21,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted);font-size:13px}
    .list{margin-top:10px;display:grid;gap:10px}

    .item{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:12px;align-items:flex-start;transition:all .2s}
    .item:hover{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.08);transform:translateY(-2px)}
    .left{min-width:220px}
    .topline{font-weight:1000}
    .subline{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.35}
    .right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;white-space:nowrap;font-weight:900;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:rgba(234,255,241,.9)}
    .tag.new{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12);color:#86efac}
    .tag.done{border-color:rgba(59,130,246,.35);background:rgba(59,130,246,.12);color:#bfdbfe}
    .tag.cancel{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fecaca}
    .amount{font-weight:1100}
    .empty{border:2px dashed rgba(255,255,255,.14);border-radius:16px;padding:18px;text-align:center;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="title">ğŸš— Mes Courses</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
    <a class="pill" href="./index.html">ğŸ  Dashboard</a>
    <a class="pill" href="./driver-zone-now.html">ğŸ“ Secteurs</a>
    <a class="pill" href="./mes-lieux.html">ğŸ“Œ Mes lieux</a>
    <div class="pill" id="pillPhone">ğŸ“± â€¦</div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card half">
      <h1>T'es en ligne frÃ©rot ! ğŸ¦…</h1>
      <p id="status">Chargementâ€¦</p>
      <div class="row">
        <button class="btn" id="btnRefresh">ğŸ”„ Actualiser</button>
        <button class="btn2" id="btnLogout">ğŸšª Me dÃ©connecter</button>
      </div>
      <p class="muted" style="margin-top:10px">Tes secteurs filtrent lâ€™affichage (pickup_zone). Sinon tu vois tout.</p>
    </section>

    <section class="card half">
      <h1>Tes courses ğŸ”¥</h1>
      <p class="muted" id="subInfo">LIVE : chargementâ€¦</p>
      <div class="list" id="list"></div>
      <div class="small" id="foot"></div>
    </section>

    <section class="card">
      <h1>Comment Ã§a marche</h1>
      <p>âœ… Tu te connectes par PIN<br>âœ… Tu choisis tes secteurs<br>âœ… Les courses sâ€™affichent (par zone de prise en charge)<br>ğŸ’° 0% commission - Tout pour toi frÃ©rot !</p>
    </section>
  </div>
</main>

<script>
(function(){
  const pillPhone=document.getElementById("pillPhone");
  const statusEl=document.getElementById("status");
  const listEl=document.getElementById("list");
  const subInfo=document.getElementById("subInfo");
  const foot=document.getElementById("foot");

  function setStatus(msg){ statusEl.textContent = msg||""; }
  function secteursActifs(){ return JSON.parse(localStorage.getItem("digiy_driver_secteurs") || "[]"); }
  function money(n){ const x=parseInt(n||0,10)||0; return x.toLocaleString("fr-FR")+" FCFA"; }
  function dt(ts){
    if(!ts) return "";
    const s=String(ts).slice(0,19).replace("T"," ");
    return s;
  }

  function tagClass(status){
    const s=(status||"").toLowerCase();
    if(s.includes("cancel")) return "cancel";
    if(s.includes("done")||s.includes("complete")) return "done";
    if(s.includes("new")||s.includes("pending")) return "new";
    return "";
  }
  function tagLabel(status){
    const s=(status||"").toLowerCase();
    if(s.includes("cancel")) return "âŒ AnnulÃ©e";
    if(s.includes("done")||s.includes("complete")) return "ğŸ TerminÃ©e";
    if(s.includes("accepted")||s.includes("assigned")) return "âœ… AcceptÃ©e";
    if(s.includes("new")||s.includes("pending")) return "ğŸ”¥ Nouvelle";
    return "ğŸ“Œ "+(status||"Course");
  }

  function render(rows, zones){
    if(!rows || rows.length===0){
      listEl.innerHTML = `
        <div class="empty">
          <div style="font-size:42px;margin-bottom:8px">ğŸ•Šï¸</div>
          Aucune course pour le moment frÃ©rot.<br>
          <span class="small">Active tes secteurs dans â€œğŸ“ Secteursâ€ ou attends une nouvelle.</span>
        </div>`;
      return;
    }
    listEl.innerHTML = rows.map(t=>{
      const pz=t.pickup_zone || t.pickup_city || "Zone";
      const dz=t.dropoff_zone || t.dropoff_city || "Destination";
      const when = dt(t.scheduled_at || t.created_at);
      const amt = money(t.amount || t.proposed_price || 0);
      const tag = tagLabel(t.status);
      const cls = tagClass(t.status);
      const code = String(t.id||"").slice(0,8).toUpperCase();
      return `
        <div class="item">
          <div class="left">
            <div class="topline">${code} â€” ${pz} â†’ ${dz}</div>
            <div class="subline">ğŸ•’ ${when || "â€”"}<br>ğŸ‘¤ ${t.client_label || "Client"} â€¢ ${t.client_phone || ""}</div>
          </div>
          <div class="right">
            <div class="tag ${cls}">${tag}</div>
            <div class="amount">${amt}</div>
          </div>
        </div>
      `;
    }).join("");
    foot.textContent = zones.length ? ("Filtre secteurs: " + zones.join(", ")) : "Aucun filtre secteur (tu vois tout).";
  }

  async function loadTrips(session){
    const zones = secteursActifs();

    pillPhone.textContent = "ğŸ“± " + (session.phone || session.slug || "ConnectÃ©");
    setStatus("â³ Chargement des vraies coursesâ€¦");
    subInfo.textContent = zones.length ? `Filtre actif: ${zones.length} secteur(s)` : "Aucun secteur sÃ©lectionnÃ© (affichage total).";

    // âœ… PIN vient maintenant du guard.js (session.pin)
    const pin = session.pin || "";
    if(!pin){
      setStatus("âš ï¸ PIN manquant. Reconnecte-toi.");
      window.DIGIY_GUARD.logout("./pin.html");
      return;
    }

    const sb = window.DIGIY_GUARD.getSb();

    const { data, error } = await sb.rpc("rpc_driver_trips_list_by_pin", {
      p_phone: session.phone,
      p_pin: pin,
      p_module: "DRIVER",
      p_limit: 50
    });

    if(error){
      console.error(error);
      setStatus("âŒ Courses LIVE KO (RPC).");
      render([], zones);
      return;
    }

    const trips = Array.isArray(data) ? data : [];

    // âœ… filtre secteurs sur pickup_zone
    const filtered = zones.length
      ? trips.filter(t => zones.includes((t.pickup_zone || t.pickup_city || "").trim()))
      : trips;

    setStatus(`âœ… ${filtered.length} course(s) affichÃ©e(s)`);
    render(filtered, zones);
  }

  function boot(){
    const s = window.DIGIY_GUARD.requireSession("./pin.html");
    if(!s) return;
    loadTrips(s);
  }

  document.getElementById("btnRefresh").addEventListener("click",()=>boot());
  document.getElementById("btnLogout").addEventListener("click",()=>{
    confirm("Tu veux vraiment te dÃ©connecter frÃ©rot ?") && window.DIGIY_GUARD.logout("./pin.html");
  });

  // si guard prÃªt
  if(window.DIGIY_GUARD?.requireSession) boot();
  else window.addEventListener("DIGIY_GUARD_READY", boot);
})();
</script>
</body>
</html>
