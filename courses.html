<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mes Courses â€” DIGIY DRIVER PRO</title>
  <meta name="theme-color" content="#061b14"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--r:18px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(6,27,20,.75);border-bottom:1px solid var(--line);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.2px;font-size:18px}
    .pill{padding:8px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted);background:rgba(0,0,0,.22);display:inline-flex;gap:8px;align-items:center;white-space:nowrap}
    a.pill{text-decoration:none}
    main{padding:16px;max-width:980px;margin:0 auto}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.32)}
    @media(min-width:860px){.card.half{grid-column:span 6}}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.45}
    button{border:0;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;font-size:15px}
    .btn{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012}
    .btn2{background:rgba(250,204,21,.14);color:var(--text);border:1px solid rgba(250,204,21,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .muted{color:var(--muted);font-size:13px}
    .list{margin-top:10px;display:grid;gap:10px}
    .item{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:12px;align-items:flex-start;transition:all .2s}
    .item:hover{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.08);transform:translateY(-2px)}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;white-space:nowrap;font-weight:900;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:rgba(234,255,241,.9)}
  </style>
</head>
<body>
<header>
  <div class="title">ğŸš— Mes Courses</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
    <a class="pill" href="./index.html">ğŸ  Dashboard</a>
    <a class="pill" href="./driver-zone-now.html">ğŸ“ Secteurs</a>
    <a class="pill" href="./mes-lieux.html">ğŸ“Œ Mes lieux</a>
    <div class="pill" id="pillPhone">ğŸ“± â€¦</div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card half">
      <h1>T'es en ligne frÃ©rot ! ğŸ¦…</h1>
      <p id="status">Chargementâ€¦</p>
      <div class="row">
        <button class="btn" id="btnRefresh">ğŸ”„ Actualiser</button>
        <button class="btn2" id="btnLogout">ğŸšª Me dÃ©connecter</button>
      </div>
      <p class="muted" style="margin-top:10px">Tu restes connectÃ© pendant 8h - GO GO GO !</p>
    </section>

    <section class="card half">
      <h1>Tes courses ğŸ”¥</h1>
      <p class="muted">LIVE : on affiche tes courses (filtrÃ©es par tes secteurs si tu en as).</p>
      <div class="list" id="list"></div>
    </section>

    <section class="card">
      <h1>Comment Ã§a marche</h1>
      <p>âœ… Secteurs activÃ©s = tu vois surtout les courses de tes zones<br>âœ… Session expire = retour PIN<br>ğŸ’° 0% commission - Tout pour toi frÃ©rot !</p>
    </section>
  </div>
</main>

<script>
(function(){
  const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  const SESSION_KEY="DIGIY_DRIVER_PRO_SESSION";
  const SESSION_TTL_MS=288e5;

  function now(){return Date.now()}
  function getSession(){
    try{
      const raw=localStorage.getItem(SESSION_KEY), s=JSON.parse(raw);
      if(!s||!s.expires_at||now()>s.expires_at) return null;
      return s;
    }catch{return null}
  }
  function clearSession(){localStorage.removeItem(SESSION_KEY)}
  function logout(redirect="./pin.html"){
    clearSession();
    const url=new URL(location.href),slug=url.searchParams.get("slug");
    slug ? location.replace(redirect+"?slug="+encodeURIComponent(slug)) : location.replace(redirect);
  }
  function setSession(data){
    const session={...data,created_at:now(),expires_at:now()+SESSION_TTL_MS};
    localStorage.setItem(SESSION_KEY,JSON.stringify(session));
    return session;
  }
  function sb(){
    if(!window.__digiy_sb__) window.__digiy_sb__=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    return window.__digiy_sb__;
  }
  window.DIGIY_GUARD={getSession,setSession,logout,sb};
})();
</script>

<script>
const pillPhone=document.getElementById("pillPhone");
const statusEl=document.getElementById("status");
const listEl=document.getElementById("list");

function setStatus(msg){statusEl.textContent=msg||""}
function secteursActifs(){ return JSON.parse(localStorage.getItem("digiy_driver_secteurs") || "[]"); }

function tagFor(status){
  const s=(status||"").toLowerCase();
  if(s.includes("new")||s.includes("pending")) return "ğŸ”¥ Nouvelle";
  if(s.includes("accepted")||s.includes("assigned")) return "âœ… AcceptÃ©e";
  if(s.includes("done")||s.includes("completed")) return "ğŸ TerminÃ©e";
  if(s.includes("cancel")) return "âŒ AnnulÃ©e";
  return "ğŸ“Œ "+(status||"Course");
}

function zoneOf(t){ return t.pickup_zone || t.pickup_city || "Zone"; }
function whenOf(t){ return t.scheduled_at || t.created_at || ""; }
function idOf(t){ return (t.id||"").slice(0,8).toUpperCase() || "COURSE"; }

function renderRows(rows){
  if(!rows || rows.length===0){
    listEl.innerHTML = `
      <div class="item">
        <div>
          <div style="font-weight:900">Aucune course trouvÃ©e frÃ©rot</div>
          <div class="muted">Active tes zones dans ğŸ“ Secteurs ou attends une nouvelle course</div>
        </div>
        <div class="tag">â³</div>
      </div>
    `;
    return;
  }
  listEl.innerHTML = rows.map(t=>{
    const zone=zoneOf(t);
    const when=String(whenOf(t)).slice(0,19).replace('T',' ');
    const tag=tagFor(t.status);
    return `
      <div class="item">
        <div>
          <div style="font-weight:900">${idOf(t)} â€” ${zone}</div>
          <div class="muted">${when}</div>
        </div>
        <div class="tag">${tag}</div>
      </div>
    `;
  }).join("");
}

async function loadTripsLive(session){
  const sb=window.DIGIY_GUARD.sb();
  const zones=secteursActifs();

  setStatus("â³ Chargement des vraies coursesâ€¦");

  // âš ï¸ Il faut que session.pin existe (voir note juste aprÃ¨s)
  const { data, error } = await sb.rpc("rpc_driver_trips_list_by_pin", {
    p_phone: session.phone,
    p_pin: session.pin,
    p_module: "DRIVER",
    p_limit: 50
  });

  if(error){
    console.error(error);
    setStatus("âŒ Courses LIVE KO (PIN/session).");
    renderRows([]);
    return;
  }

  const trips = Array.isArray(data) ? data : [];
  const filtered = zones.length ? trips.filter(t => zones.includes(zoneOf(t))) : trips;

  setStatus(`âœ… ${filtered.length} course(s)`);
  renderRows(filtered);
}

async function boot(){
  const session=window.DIGIY_GUARD.getSession();
  if(!session || !session.owner_id){
    const url=new URL(location.href),slug=url.searchParams.get("slug");
    location.replace(slug?`./pin.html?slug=${encodeURIComponent(slug)}`:"./pin.html");
    return;
  }

  pillPhone.textContent="ğŸ“± "+(session.phone||session.slug||"ConnectÃ©");

  if(!session.pin){
    setStatus("âš ï¸ Il manque le PIN en session. Reconnecte-toi via PIN.");
    // sÃ©curitÃ© : on force la reconnexion propre
    window.DIGIY_GUARD.logout("./pin.html");
    return;
  }

  setStatus(`âœ… ConnectÃ© ${session.title||"frÃ©rot"} ğŸ¦…`);
  await loadTripsLive(session);
}

document.getElementById("btnRefresh").addEventListener("click",()=>boot());
document.getElementById("btnLogout").addEventListener("click",()=>{
  confirm("Tu veux vraiment te dÃ©connecter frÃ©rot ?") && window.DIGIY_GUARD.logout()
});

boot();
</script>
</body>
</html>
