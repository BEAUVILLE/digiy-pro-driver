<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DIGIY DRIVER ‚Äî Auth Chauffeur (PIN)</title>
  <meta name="theme-color" content="#F8FAF6" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#F8FAF6; --card:#fff; --line:#E5E7EB;
      --text:#111827; --muted:#6B7280;
      --gold:#EAB308; --radius:20px; --shadow:0 12px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(234,179,8,.18), transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, rgba(245,158,11,.15), transparent 55%),
        var(--bg);
      min-height:100vh; display:grid; place-items:center; padding:16px;
    }
    .card{
      width:min(520px, 92vw);
      border:1px solid var(--line); border-radius:var(--radius);
      background:var(--card); box-shadow:var(--shadow); padding:16px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;display:grid;place-items:center;
      border:1px solid var(--line);
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);
      color:#92400E;font-weight:950;font-size:20px;
    }
    h1{margin:0;font-size:18px}
    .sub{margin:4px 0 0;color:var(--muted);font-weight:650}
    label{display:block;margin:12px 0 8px;font-weight:950}
    input{
      width:100%;border:1px solid var(--line);border-radius:16px;
      padding:12px 12px;font-size:15px;background:#fff;outline:none;
    }
    input:focus{border-color:#FDE68A;box-shadow:0 0 0 4px rgba(234,179,8,.12)}
    .btn{
      width:100%;
      border:0;border-radius:16px;padding:12px 14px;min-height:44px;
      font-weight:950;cursor:pointer;margin-top:14px;
      background:linear-gradient(135deg,#FFF7D6,#FDE68A);color:#78350F;
    }
    .btn.ghost{
      background:#F9FAFB;color:#374151;border:1px solid var(--line);
      margin-top:10px;font-weight:900;
    }
    .msg{
      margin-top:12px;padding:12px;border-radius:16px;border:1px solid var(--line);
      background:#F9FAFB;color:var(--muted);font-weight:800;line-height:1.25;
      white-space:pre-wrap;
    }
    .msg.ok{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#14532d}
    .msg.bad{border-color:rgba(239,68,68,.22); background:rgba(239,68,68,.06); color:#7f1d1d}
    .small{font-size:12px;color:var(--muted);font-weight:700;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <div class="brand">
      <div class="logo">‚àû</div>
      <div>
        <h1>DIGIY DRIVER PRO ‚Äî Connexion</h1>
        <div class="sub">T√©l√©phone + PIN (cl√© chauffeur)</div>
      </div>
    </div>

    <label>T√©l√©phone chauffeur</label>
    <input id="phone" type="tel" inputmode="tel" placeholder="+221 77 XXX XX XX" />

    <label>PIN</label>
    <input id="pin" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

    <button class="btn" id="loginBtn">Se connecter</button>
    <button class="btn ghost" id="backBtn">Retour</button>

    <div class="msg" id="msg">Entre ton t√©l√©phone et ton PIN.</div>
    <div class="small">GitHub Pages: URLs en /digiy-pro-driver/... (pas √† la racine).</div>
  </div>

<script>
(function(){
  'use strict';

  /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const path = location.pathname || "/";
  const parts = path.split("/").filter(Boolean);
  const BASE = (parts.length >= 1) ? ("/" + parts[0]) : "";

  const $ = (id)=>document.getElementById(id);
  const msg = $("msg");

  function normPhone(p){
    p = (p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
    if(p.startsWith("00221")) p = "+221" + p.slice(5);
    if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
    if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
    return p;
  }

  function setMsg(text, ok){
    msg.className = "msg" + (ok===true ? " ok" : ok===false ? " bad" : "");
    msg.textContent = text;
  }

  async function verifyPin(phone, pin){
    // ‚úÖ Quand tu veux, on branche sur ton vrai RPC:
    // const { data, error } = await sb.rpc("verify_driver_pin", { p_phone: phone, p_pin: pin });
    // if(error) throw error;
    // return !!data;

    // ‚úÖ Fallback (fonctionnel pour tester le flow)
    return (pin && pin.length >= 3);
  }

  $("loginBtn").addEventListener("click", async ()=>{
    const phone = normPhone($("phone").value);
    const pin = ($("pin").value||"").trim();

    if(!phone.startsWith("+221")){
      setMsg("‚ö†Ô∏è T√©l√©phone invalide. Exemple: +221771234567", false);
      return;
    }
    if(!pin){
      setMsg("‚ö†Ô∏è PIN manquant.", false);
      return;
    }

    $("loginBtn").disabled = true;
    setMsg("‚è≥ V√©rification...", null);

    try{
      const ok = await verifyPin(phone, pin);
      if(!ok){
        setMsg("‚õîÔ∏è PIN incorrect.", false);
        return;
      }

      sessionStorage.setItem("digiy_driver_phone", phone);
      localStorage.setItem("digiy_driver_access_pin", JSON.stringify({ phone, ts: Date.now() }));

      setMsg("‚úÖ Connect√©. Redirection...", true);
      location.replace(BASE + "/courses.html");
    }catch(e){
      console.error(e);
      setMsg("‚ùå Erreur connexion. V√©rifie Supabase / r√©seau.", false);
    }finally{
      $("loginBtn").disabled = false;
    }
  });

  $("backBtn").addEventListener("click", ()=>location.replace(BASE + "/index.html"));
})();
</script>
</body>
</html>



