<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mes Lieux ‚Äî DIGIY DRIVER PRO</title>
  <meta name="theme-color" content="#061b14"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./guard.js?v=driver-guard-final"></script>

  <style>
    :root{--bg:#061b14;--card:#0b2a1f;--line:rgba(255,255,255,.14);--text:#eafff1;--muted:rgba(234,255,241,.78);--green:#16a34a;--gold:#facc15;--r:18px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:
      radial-gradient(900px 500px at 10% -10%,rgba(34,197,94,.20),transparent 60%),
      radial-gradient(900px 500px at 110% 0%,rgba(250,204,21,.14),transparent 55%),
      var(--bg);color:var(--text);padding:16px}
    header{max-width:980px;margin:0 auto 16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-weight:900;font-size:22px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.22);color:var(--muted);font-size:13px}
    main{max-width:980px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:var(--r);padding:20px;box-shadow:0 12px 40px rgba(0,0,0,.32);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:0;color:var(--muted);line-height:1.45;font-size:15px}
    .list{margin-top:16px;display:grid;gap:12px}
    .lieu-item{border:1px solid var(--line);border-radius:16px;padding:16px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .lieu-item.active{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.08);box-shadow:0 0 0 3px rgba(34,197,94,.12)}
    .lieu-info{flex:1;min-width:200px}
    .lieu-name{font-weight:900;font-size:16px;margin-bottom:4px}
    .lieu-slug{font-size:13px;color:var(--muted);font-family:ui-monospace,monospace}
    .lieu-actions{display:flex;gap:8px;flex-wrap:wrap}
    button,a.btn{border:0;cursor:pointer;padding:10px 16px;border-radius:12px;font-weight:900;font-size:14px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,rgba(34,197,94,.95),rgba(16,185,129,.85));color:#042012}
    .btn-secondary{background:rgba(250,204,21,.14);color:var(--text);border:1px solid rgba(250,204,21,.25)}
    .btn-ghost{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--line)}
    .btn-danger{background:rgba(239,68,68,.14);color:#fecaca;border:1px solid rgba(239,68,68,.25)}
    .btn-active{background:rgba(34,197,94,.20);color:#86efac;border:1px solid rgba(34,197,94,.35);cursor:default}
    .add-form{border-top:1px solid var(--line);margin-top:16px;padding-top:16px;display:none}
    .add-form.show{display:block}
    label{display:block;font-size:13px;color:rgba(234,255,241,.75);margin:12px 0 6px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.22);color:var(--text);font-size:15px;outline:none}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .status{margin-top:12px;padding:12px;border-radius:12px;font-size:14px;font-weight:800;display:none}
    .status.show{display:block}
    .status.ok{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac}
    .status.error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#fecaca}
    .empty{text-align:center;padding:40px 20px;color:var(--muted);border:2px dashed rgba(255,255,255,.14);border-radius:16px}
    .tiny{font-size:12px;color:rgba(234,255,241,.72);margin-top:8px}
    code{font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#bbf7d0}
  </style>
</head>

<body>
<header>
  <div class="title">üìç Mes Lieux de Travail</div>
  <div class="pill" id="pillPhone">üì± ‚Ä¶</div>
</header>

<main>
  <div class="card">
    <h1>Tous tes lieux ü¶Ö</h1>
    <p>G√®re tes points de travail. Clique sur <b>Activer</b> pour bosser depuis ce lieu.</p>

    <div id="listContainer">
      <div class="empty">
        <div style="font-size:48px;margin-bottom:12px">‚è≥</div>
        Chargement fr√©rot...
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button class="btn-secondary" id="btnShowAdd">‚ûï Cr√©er un lieu</button>
      <a class="btn-ghost" id="btnBack" href="./index.html">‚Üê Retour accueil</a>
    </div>

    <div class="tiny" id="debugLine"></div>
  </div>

  <div class="card add-form" id="addForm">
    <h1>Nouveau lieu de travail</h1>
    <p>Cr√©e un nouveau point d'activit√© (ville, zone, quartier...)</p>

    <label>Nom du lieu *</label>
    <input id="inputTitle" placeholder="Ex: Moussa VTC Dakar, Transport Saly Centre..."/>
    <p class="tiny">Le slug sera g√©n√©r√© automatiquement</p>

    <div class="row">
      <button class="btn-primary" id="btnCreate">‚úÖ C'est bon, cr√©er</button>
      <button class="btn-ghost" id="btnCancelAdd">Annuler</button>
    </div>

    <div class="status" id="addStatus"></div>
  </div>
</main>

<script>
(async()=>{
  // --------- session
  const session = window.DIGIY_GUARD?.requireSession?.("./pin.html");
  if(!session) return;

  const sb = await window.DIGIY_GUARD.getSbAsync();
  const owner_id_raw = session.owner_id;           // peut √™tre UUID ou texte
  const current_slug = (session.slug || "").trim().toLowerCase();

  const pillPhone = document.getElementById("pillPhone");
  const listContainer = document.getElementById("listContainer");
  const addForm = document.getElementById("addForm");
  const addStatus = document.getElementById("addStatus");
  const inputTitle = document.getElementById("inputTitle");
  const btnCreate = document.getElementById("btnCreate");
  const debugLine = document.getElementById("debugLine");
  const btnBack = document.getElementById("btnBack");

  pillPhone.textContent = "üì± " + (session.phone || "Connect√©");

  // garde le slug sur retour
  const backUrl = new URL("./index.html", location.href);
  if(current_slug) backUrl.searchParams.set("slug", current_slug);
  btnBack.href = backUrl.toString();

  function escapeHtml(text){
    const div = document.createElement("div");
    div.textContent = (text ?? "");
    return div.innerHTML;
  }

  function isUuid(v){
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(v||"").trim());
  }

  function showStatus(msg,type="ok"){
    addStatus.className = `status show ${type}`;
    addStatus.textContent = msg;
  }
  function hideStatus(){
    addStatus.className = "status";
    addStatus.textContent = "";
  }

  // --------- RPC wrappers (uuid/text) to avoid ambiguity
  async function rpcGetOwnerSlugs(ownerId){
    const isU = isUuid(ownerId);
    debugLine.innerHTML = `owner_id=<code>${escapeHtml(String(ownerId))}</code> ‚Ä¢ mode=<code>${isU ? "UUID" : "TEXT"}</code>`;

    // 1) try function name explicit if you have both
    if(isU){
      // try get_owner_slugs_uuid
      let r = await sb.rpc("get_owner_slugs_uuid", { p_owner_id: ownerId });
      if(!r.error) return r;

      // fallback generic get_owner_slugs (uuid)
      r = await sb.rpc("get_owner_slugs", { p_owner_id: ownerId });
      return r;
    }else{
      // try get_owner_slugs_text
      let r = await sb.rpc("get_owner_slugs_text", { p_owner_id: String(ownerId) });
      if(!r.error) return r;

      // fallback generic get_owner_slugs_text again if your db uses that only
      return r;
    }
  }

  async function rpcCreateNewSlug(ownerId, title, phone){
    const isU = isUuid(ownerId);

    const payloadUuid = { p_owner_id: ownerId, p_title: title, p_phone: phone || "", p_module: "DRIVER" };
    const payloadText = { p_owner_id: String(ownerId), p_title: title, p_phone: phone || "", p_module: "DRIVER" };

    if(isU){
      // try explicit uuid version
      let r = await sb.rpc("create_new_slug_uuid", payloadUuid);
      if(!r.error) return r;

      // fallback generic create_new_slug (uuid)
      r = await sb.rpc("create_new_slug", payloadUuid);
      return r;
    }else{
      // try explicit text version
      let r = await sb.rpc("create_new_slug_text", payloadText);
      if(!r.error) return r;

      // fallback generic create_new_slug (text)
      r = await sb.rpc("create_new_slug", payloadText);
      return r;
    }
  }

  async function rpcDeleteSlug(ownerId, slug){
    const isU = isUuid(ownerId);

    const payloadUuid = { p_owner_id: ownerId, p_slug: slug };
    const payloadText = { p_owner_id: String(ownerId), p_slug: slug };

    if(isU){
      let r = await sb.rpc("delete_slug_uuid", payloadUuid);
      if(!r.error) return r;

      r = await sb.rpc("delete_slug", payloadUuid);
      return r;
    }else{
      let r = await sb.rpc("delete_slug_text", payloadText);
      if(!r.error) return r;

      r = await sb.rpc("delete_slug", payloadText);
      return r;
    }
  }

  // --------- UI actions
  window.supprimerLieu = async function(slug, title, isActive){
    const msg = isActive
      ? `‚ö†Ô∏è Tu supprimes ton lieu ACTIF "${title}". Continuer ?`
      : `Supprimer "${title}" ? (irr√©versible)`;
    if(!confirm(msg)) return;

    try{
      const { data, error } = await rpcDeleteSlug(owner_id_raw, slug);
      if(error) throw error;

      const result = (typeof data === "string") ? JSON.parse(data) : data;
      if(result && result.ok === false) throw new Error(result.error || "Suppression refus√©e");

      // si tu supprimes l'actif ‚Üí on nettoie session si besoin
      if(isActive){
        alert("Lieu actif supprim√©. On repasse sur un autre lieu si dispo.");
      }
      await loadLieux();

    }catch(err){
      console.error(err);
      alert("‚ùå Erreur: " + (err?.message || "inconnue"));
    }
  };

  async function loadLieux(){
    try{
      const { data, error } = await rpcGetOwnerSlugs(owner_id_raw);
      if(error) throw error;

      const rows = (data || []);
      if(!rows.length){
        listContainer.innerHTML =
          '<div class="empty"><div style="font-size:48px;margin-bottom:12px">üìç</div>'+
          'Aucun lieu trouv√©.<br>Clique sur "Cr√©er un lieu" pour commencer.</div>';
        return;
      }

      listContainer.innerHTML = `
        <div class="list">
          ${rows.map(lieu=>{
            const slug = String(lieu.slug || "").toLowerCase();
            const isActive = slug === current_slug;
            return `
              <div class="lieu-item ${isActive ? "active" : ""}">
                <div class="lieu-info">
                  <div class="lieu-name">${escapeHtml(lieu.title || "Lieu")}</div>
                  <div class="lieu-slug">${escapeHtml(lieu.slug || "")}</div>
                </div>

                <div class="lieu-actions">
                  ${
                    isActive
                      ? `<button class="btn-active" disabled>‚úÖ Actif ici</button>`
                      : `<button class="btn-primary js-activer"
                          data-slug="${escapeHtml(lieu.slug)}"
                          data-title="${escapeHtml(lieu.title)}"
                          data-phone="${escapeHtml(lieu.phone || "")}"
                        >Activer</button>`
                  }

                  <button class="btn-danger js-supprimer"
                    data-slug="${escapeHtml(lieu.slug)}"
                    data-title="${escapeHtml(lieu.title)}"
                    data-active="${isActive ? "1" : "0"}"
                  >üóëÔ∏è</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }catch(err){
      console.error(err);
      listContainer.innerHTML =
        `<div class="empty"><div style="font-size:48px;margin-bottom:12px">‚ùå</div>`+
        `Erreur de chargement fr√©rot<br><small>${escapeHtml(err?.message || "inconnue")}</small></div>`;
    }
  }

  // Event delegation
  listContainer.addEventListener("click", async (e)=>{
    const actBtn = e.target.closest(".js-activer");
    if(actBtn){
      const slug = (actBtn.dataset.slug || "").trim().toLowerCase();
      const title = actBtn.dataset.title || "";
      const phone = actBtn.dataset.phone || session.phone || "";

      // ‚úÖ set session (driver)
      localStorage.setItem("DIGIY_DRIVER_PRO_SESSION", JSON.stringify({
        ok:true,
        owner_id: owner_id_raw,
        slug,
        title,
        phone,
        created_at: Date.now(),
        expires_at: Date.now() + (8*60*60*1000)
      }));

      // Option A terrain: Activer -> go direct zone now
      const target = new URL("./driver-zone-now.html", location.href);
      target.searchParams.set("slug", slug);
      location.href = target.toString();
      return;
    }

    const delBtn = e.target.closest(".js-supprimer");
    if(delBtn){
      const slug = delBtn.dataset.slug;
      const title = delBtn.dataset.title;
      const isActive = delBtn.dataset.active === "1";
      await window.supprimerLieu(slug, title, isActive);
      return;
    }
  });

  // UI add form
  document.getElementById("btnShowAdd").addEventListener("click", ()=>{
    addForm.classList.add("show");
    inputTitle.focus();
    hideStatus();
  });
  document.getElementById("btnCancelAdd").addEventListener("click", ()=>{
    addForm.classList.remove("show");
    inputTitle.value="";
    hideStatus();
  });

  btnCreate.addEventListener("click", async ()=>{
    const title = inputTitle.value.trim();
    if(!title){
      showStatus("‚ö†Ô∏è Entre un nom fr√©rot", "error");
      return;
    }

    try{
      hideStatus();
      btnCreate.disabled = true;
      btnCreate.textContent = "‚è≥ Cr√©ation...";

      const { data, error } = await rpcCreateNewSlug(owner_id_raw, title, session.phone);
      if(error) throw error;

      const result = (typeof data === "string") ? JSON.parse(data) : data;
      if(result && result.ok === false) throw new Error(result.error || "Cr√©ation refus√©e");

      showStatus(`‚úÖ Lieu cr√©√© : ${result.slug || "OK"}`, "ok");

      setTimeout(async ()=>{
        inputTitle.value="";
        addForm.classList.remove("show");
        await loadLieux();
      }, 800);

    }catch(err){
      console.error(err);
      showStatus("‚ùå Erreur : " + (err?.message || "inconnue"), "error");
    }finally{
      btnCreate.disabled = false;
      btnCreate.textContent = "‚úÖ C'est bon, cr√©er";
    }
  });

  await loadLieux();
})();
</script>
</body>
</html>
